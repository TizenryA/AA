{
  "spec": "chara_card_v3",
  "spec_version": "3.0",
  "data": {
    "avatar": null,
    "name": "æ¸¡é¸¦ç”Ÿå›¾æ­£åˆ™ v2.3",
    "description": "NovelAIåœºæ™¯æ’å›¾ç”Ÿæˆé¢æ¿",
    "first_mes": "",
    "personality": "",
    "scenario": "",
    "mes_example": "",
    "creator_notes": "ã€æ¸¡é¸¦ç”Ÿå›¾æ­£åˆ™ v2.3ã€‘\n\næ ¸å¿ƒåŠŸèƒ½ï¼š\n- NovelAIå…¨ç³»åˆ—æ¨¡å‹æ”¯æŒï¼ˆV4.5/V4/V3ï¼‰\n- AIæ™ºèƒ½æ¨¡å¼ï¼ˆLLMåˆ†ææ­£æ–‡å®Œå–„æç¤ºè¯ï¼‰\n- è§’è‰²DNAç³»ç»Ÿï¼ˆæ¥æºæ ‡ç­¾+å¤–è²Œæè¿°ï¼‰\n- ç”»é£é¢„è®¾ç³»ç»Ÿï¼ˆ5å†…ç½®+è‡ªå®šä¹‰ï¼Œå…¨å‚æ•°å¯ç¼–è¾‘ï¼‰\n- GitHubç¼“å­˜ç³»ç»Ÿï¼ˆåœºæ™¯IDå¤ç”¨+äº‘ç«¯åŒæ­¥ï¼‰\n- å¤šæ¨¡å‹æ”¯æŒï¼ˆç”Ÿå›¾3ä¸ª+LLM3ä¸ªä½ç½®ï¼‰\n\nä½¿ç”¨æ–¹æ³•ï¼š\n1. åœ¨é…ç½®åŒºå¡«å…¥API Key\n2. AIè¾“å‡º<story>æ­£æ–‡</story>å’Œ<scene id=\"åœºæ™¯ID\">æç¤ºè¯</scene>\n3. ç›¸åŒåœºæ™¯IDå¤ç”¨ç¼“å­˜\n4. ç‚¹å‡»ç”Ÿæˆå›¾ç‰‡\n\nä½œè€…ï¼šæ¸¡é¸¦4455",
    "system_prompt": "",
    "post_history_instructions": "",
    "alternate_greetings": null,
    "character_book": {
      "name": "æ¸¡é¸¦ç”Ÿå›¾è§„åˆ™",
      "entries": [
        {
          "keys": [
            "å¤æ‚åœºæ™¯",
            "å¤šäºº",
            "è¿›é˜¶",
            "Xçº§",
            "nsfw"
          ],
          "content": "ã€NAIè¿›é˜¶è§„åˆ™ã€‘\n\n## åˆ†çº§ç³»ç»Ÿ\n- Safeï¼ˆæ—¥å¸¸ï¼‰ï¼šæ— å‰ç¼€ï¼Œå¿…é¡»{fully clothed}\n- Rçº§ï¼ˆæš´éœ²ï¼‰ï¼šå‰ç¼€{{nsfw}},\n- Xçº§ï¼ˆè£¸éœ²/æ€§è¡Œä¸ºï¼‰ï¼šå‰ç¼€{{nsfw}}, {{uncensored}},\n\n## æƒé‡ä½“ç³»\nè¶…å¼ºè°ƒ: {{{{tag}}}} = 1.22x\nå¼ºè°ƒ: {{{tag}}} = 1.16x\nä¸­è°ƒ: {{tag}} = 1.10x\nè½»è°ƒ: {tag} = 1.05x\nç²¾ç¡®: (tag:1.5)\næ’æ–¥: -1.5::tag::\n\n## èƒ¸éƒ¨ç­‰çº§é”\n| ç­‰çº§ | Prompt | æ’æ–¥ |\n|-----|--------|------|\n| å¹³ | {{flat chest}} | breasts |\n| å° | {small breasts} | flat, large |\n| ä¸­ | {medium breasts} | flat, huge |\n| å¤§ | {{large breasts}} | flat, small |\n\n## åœºæ™¯IDè¿›é˜¶\nR/Xçº§åœºæ™¯IDæ ¼å¼ï¼šlocation_action_rating\nç¤ºä¾‹ï¼šbedroom_kiss_rã€dungeon_bound_x\n\n## å¤šäººäº’æ–¥åè®®\n- ç©ºé—´è¯ä¸é‡å¤ï¼šAç”¨{on left}ï¼ŒBç”¨{on right}\n- äº’åŠ¨åŒå‘ï¼šAå†™{hugging}ï¼ŒBå†™{being hugged}",
          "extensions": {
            "selectiveLogic": 0,
            "position": 4,
            "depth": 4,
            "role": 0,
            "match_whole_words": true,
            "probability": 100,
            "useProbability": true,
            "sticky": 0,
            "cooldown": 0,
            "delay": 0,
            "exclude_recursion": false,
            "prevent_recursion": false,
            "delay_until_recursion": false,
            "group": "",
            "group_override": false,
            "group_weight": 100,
            "use_group_scoring": false,
            "scan_depth": 4,
            "case_sensitive": false,
            "automation_id": "",
            "vectorized": false
          },
          "enabled": true,
          "use_regex": false,
          "insertion_order": 3,
          "id": 0,
          "name": "å¤æ‚åœºæ™¯",
          "comment": "å¤æ‚åœºæ™¯",
          "selective": false,
          "case_sensitive": false,
          "constant": false,
          "position": "after_char",
          "display_index": 1
        },
        {
          "keys": [],
          "content": "ã€NAIæ’å›¾ç”Ÿæˆè§„åˆ™ã€‘\n\n## åœºæ™¯IDè§„åˆ™ï¼ˆé‡è¦ï¼ï¼‰\nåœºæ™¯IDç”¨äºç¼“å­˜åˆ¤æ–­ï¼Œç›¸åŒåœºæ™¯åº”ä½¿ç”¨ç›¸åŒIDï¼š\n- æ ¼å¼ï¼šåœ°ç‚¹_åŠ¨ä½œ_æƒ…ç»ªï¼Œç”¨è‹±æ–‡ä¸‹åˆ’çº¿è¿æ¥\n- ç¤ºä¾‹ï¼šclassroom_smileã€cafe_blushã€bedroom_sleep\n- åŒä¸€åœºæ™¯å¤šæ¬¡å‡ºç°æ—¶ä¿æŒIDä¸€è‡´\n- IDåº”ç®€çŸ­æœ‰æ„ä¹‰ï¼Œ3-5ä¸ªå•è¯\n\n## æ ¸å¿ƒï¼šä¸»ä½“åˆ¤æ–­\n1. è¿™æ®µæ­£æ–‡è§†è§‰ç„¦ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿâ†’ é‚£ä¸ªå…ƒç´ æƒé‡æœ€é«˜\n2. ä»€ä¹ˆä¼šç ´åç”»é¢ï¼Ÿâ†’ ä¸è¦å†™å…¥\n3. è§’è‰²æ˜¯ç„¦ç‚¹è¿˜æ˜¯è½½ä½“ï¼Ÿâ†’ ç„¦ç‚¹é«˜æƒé‡ï¼Œè½½ä½“æ­£å¸¸æƒé‡\n\n## æƒé‡è¯­æ³•\n{tag} = +5%å¼ºè°ƒï¼Œå¯å åŠ ï¼š{{tag}}=+10%, {{{tag}}}=+16%\n[tag] = -5%å¼±åŒ–\n\n## æç¤ºè¯ç»“æ„ï¼ˆæŒ‰é¡ºåºï¼‰\n1. äººæ•°é”šå®šï¼š1girl, solo / 1boy, solo / 2girls / 1girl, 1boy\n2. è§’è‰²å¤–è§‚ï¼šå‘è‰²å‘å‹, ç³è‰², èº«æï¼ˆä¿æŒDNAä¸€è‡´ï¼‰\n3. æœè£…ï¼šå¿…é¡»å¸¦é¢œè‰²ï¼{red dress}è€Œédress\n4. è¡¨æƒ…ï¼šä»æ­£æ–‡æå–ï¼ŒåŠ æƒé‡ {smile}, {{blush}}\n5. å§¿æ€é”šå®šï¼š{standing}, {sitting}, {lying}ï¼ˆå¿…é¡»æ˜ç¡®ï¼‰\n6. æ‰‹éƒ¨å¤„ç†ï¼šæ˜ç¡®åŠ¨ä½œholding_x æˆ– è—èµ·æ¥hands_behind_back\n7. è§†è§’ï¼šlooking_at_viewer, from_side, from_above\n8. åœºæ™¯+å…‰çº¿ï¼šä»æ­£æ–‡æå–\n\n## DNAä¸€è‡´æ€§\nè§’è‰²å¤–è²Œä¸€æ—¦ç¡®å®šï¼Œåç»­æ‰€æœ‰å›¾å¿…é¡»ä¸€è‡´ï¼š\n- å‘è‰²å‘å‹é”å®š\n- ç³è‰²é”å®š\n- æœè£…é¢œè‰²é”å®šï¼ˆé™¤éæ­£æ–‡æ˜ç¡®æ¢è£…ï¼‰\n\n## å¤šäººåœºæ™¯ï¼ˆ2äººä»¥ä¸Šï¼‰\n- åˆ é™¤soloï¼æ”¹ç”¨{duo}, {group}\n- ç©ºé—´åæ ‡ï¼š{on left}, {on right}\n- æ¯äººDNAå®Œæ•´\n- IDæ ¼å¼ï¼šlocation_action_duo\n\n## ç¦æ­¢\nâŒ è‡ªç„¶è¯­è¨€æè¿°\nâŒ çœç•¥äººæ•°é”šå®š\nâŒ æœè£…ä¸å¸¦é¢œè‰²\nâŒ å§¿æ€å†²çªï¼ˆstanding + sittingï¼‰\nâŒ çœç•¥åœºæ™¯ID\nâŒ æ­£æ–‡ä¸åŒ…è£¹storyæ ‡ç­¾",
          "extensions": {
            "selectiveLogic": 0,
            "position": 0,
            "depth": 4,
            "role": 0,
            "match_whole_words": true,
            "probability": 100,
            "useProbability": true,
            "sticky": 0,
            "cooldown": 0,
            "delay": 0,
            "exclude_recursion": false,
            "prevent_recursion": false,
            "delay_until_recursion": false,
            "group": "",
            "group_override": false,
            "group_weight": 100,
            "use_group_scoring": false,
            "scan_depth": 2,
            "case_sensitive": false,
            "automation_id": "",
            "vectorized": false
          },
          "enabled": true,
          "use_regex": false,
          "insertion_order": 2,
          "id": 1,
          "name": "ç”Ÿå›¾è§„åˆ™",
          "comment": "ç”Ÿå›¾è§„åˆ™",
          "selective": false,
          "case_sensitive": false,
          "constant": true,
          "position": "before_char",
          "display_index": 2
        },
        {
          "keys": [],
          "content": "ã€è¾“å‡ºæ ¼å¼è§„èŒƒã€‘\n\n## æ­£æ–‡æ ¼å¼\næ‰€æœ‰æ­£æ–‡å†…å®¹å¿…é¡»åŒ…è£¹åœ¨storyæ ‡ç­¾å†…ï¼š\n<story>\næ­£æ–‡å†…å®¹...\n</story>\n\n## æ’å›¾æ ¼å¼\næ¯æ¬¡å›å¤æœ«å°¾è¾“å‡ºï¼š\n<scene id=\"åœºæ™¯ID\">è‹±æ–‡æç¤ºè¯</scene>\n\n## å®Œæ•´ç¤ºä¾‹\n<story>\nå¥¹ç«™åœ¨æ•™å®¤çª—è¾¹ï¼Œé˜³å…‰æ´’åœ¨å¥¹çš„ä¾§è„¸ä¸Šï¼Œå˜´è§’å¸¦ç€ä¸€ä¸å¾®ç¬‘ã€‚\n</story>\n\n<scene id=\"classroom_smile_sunlight\">1girl, solo, long black hair, blue eyes, school uniform, standing, by window, classroom, sunlight, {smile}, looking at viewer, upper body</scene>",
          "extensions": {
            "selectiveLogic": 0,
            "position": 0,
            "depth": 4,
            "role": 0,
            "match_whole_words": true,
            "probability": 100,
            "useProbability": true,
            "sticky": 0,
            "cooldown": 0,
            "delay": 0,
            "exclude_recursion": false,
            "prevent_recursion": false,
            "delay_until_recursion": false,
            "group": "",
            "group_override": false,
            "group_weight": 100,
            "use_group_scoring": false,
            "scan_depth": 2,
            "case_sensitive": false,
            "automation_id": "",
            "vectorized": false
          },
          "enabled": true,
          "use_regex": false,
          "insertion_order": 1,
          "id": 2,
          "name": "è¾“å‡ºæ ¼å¼",
          "comment": "è¾“å‡ºæ ¼å¼",
          "selective": false,
          "case_sensitive": false,
          "constant": true,
          "position": "before_char",
          "display_index": 3
        }
      ]
    },
    "tags": [
      "ç”Ÿå›¾",
      "NAI",
      "NovelAI",
      "æ’å›¾",
      "æ¸¡é¸¦"
    ],
    "creator": "æ¸¡é¸¦4455",
    "character_version": "2.3",
    "nickname": null,
    "creator_notes_multilingual": null,
    "source": null,
    "group_only_greetings": null,
    "creation_date": 1770352898,
    "modification_date": 1770352898,
    "extensions": {
      "regex_scripts": [
        {
          "id": "7ca4e941-07f1-4970-a562-691a045302ed",
          "scriptName": "00-storyæ­£æ–‡æ¸²æŸ“",
          "findRegex": "<story>([\\s\\S]*?)</story>",
          "replaceString": "<div class=\"nai-story\" style=\"line-height:1.8;margin:8px 0\">$1</div>",
          "trimStrings": [],
          "placement": [
            2
          ],
          "disabled": false,
          "markdownOnly": true,
          "promptOnly": false,
          "runOnEdit": false,
          "substituteRegex": 0,
          "minDepth": null,
          "maxDepth": null
        },
        {
          "id": "fdc44ae7-fe8f-4f07-bb1f-6d5318b621d0",
          "scriptName": "01-æ¸¡é¸¦ç”Ÿå›¾æ­£åˆ™ v2.3",
          "findRegex": "<scene id=\"([^\"]+)\">([\\s\\S]*?)</scene>",
          "replaceString": "<style>.nai-panel{background:linear-gradient(135deg,#0d1520,#0a0a14);border:1px solid #1a2a3a;border-radius:8px;margin:6px 0;overflow:hidden;font-family:-apple-system,sans-serif}.nai-page{display:none}.nai-page.show{display:block}.nai-page-header{padding:10px 12px;border-bottom:1px solid #1a2a3a;display:flex;align-items:center;gap:10px}.nai-back-btn{background:none;border:none;color:#4a9eff;font-size:14px;cursor:pointer;padding:4px 8px}.nai-back-btn:hover{color:#6ab0ff}.nai-page-title{color:#4a9eff;font-size:13px;font-weight:500}.nai-page-body{padding:12px;max-height:70vh;overflow-y:auto}.nai-header{padding:10px 12px;border-bottom:1px solid #1a2a3a;display:flex;align-items:flex-start;justify-content:space-between;gap:10px}.nai-header-left{display:flex;align-items:center;gap:6px}.nai-eagle{display:inline-block;font-size:18px;animation:eagleFloat 2s ease-in-out infinite}.nai-title-text{font-size:14px;font-weight:600;color:#4a9eff;text-shadow:0 0 10px rgba(74,158,255,0.8),0 0 20px rgba(167,139,250,0.6);animation:textGlow 2s ease-in-out infinite}@keyframes eagleFloat{0%,100%{transform:translateY(0) rotate(-3deg)}50%{transform:translateY(-4px) rotate(3deg)}}@keyframes textGlow{0%,100%{text-shadow:0 0 10px rgba(74,158,255,0.8),0 0 20px rgba(167,139,250,0.4)}50%{text-shadow:0 0 15px rgba(167,139,250,1),0 0 30px rgba(74,158,255,0.8)}}.nai-conn-list{display:flex;flex-direction:column;gap:2px;font-size:9px;align-items:flex-end}.nai-conn-item{display:flex;align-items:center;gap:4px;color:#666;cursor:pointer}.nai-conn-item:hover{color:#888}.nai-conn-icon{width:12px;text-align:center}.nai-conn-name{max-width:90px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.nai-conn-dot{width:6px;height:6px;border-radius:50%;background:#555;flex-shrink:0}.nai-conn-dot.ok{background:#4ade80;box-shadow:0 0 4px #4ade80}.nai-conn-dot.err{background:#f87171;box-shadow:0 0 4px #f87171}.nai-conn-dot.loading{background:#4a9eff;animation:naiPulse 1s infinite}.nai-scene-bar{padding:6px 12px;background:#0a0a12;border-bottom:1px solid #1a2a3a;display:flex;align-items:center;gap:6px}.nai-scene-icon{color:#a78bfa;font-size:10px}.nai-scene-id{font-size:11px;color:#a78bfa;font-family:monospace;cursor:pointer}.nai-scene-id:hover{color:#c4b5fd}.nai-ctrl-bar{padding:8px 12px;border-bottom:1px solid #1a2a3a;display:flex;align-items:center;justify-content:space-between;gap:6px}.nai-ctrl-left{display:flex;align-items:center;gap:6px}.nai-settings-btn{width:28px;height:28px;border-radius:4px;border:1px solid #2a2a3a;background:#12121a;color:#888;cursor:pointer;font-size:14px}.nai-settings-btn:hover{background:#1a1a28;color:#4a9eff}.nai-dummy-btn{padding:4px 8px;border-radius:4px;border:1px solid #2a2a3a;background:#12121a;color:#888;cursor:pointer;font-size:10px}.nai-dummy-btn.active{background:#1a3a2a;border-color:#2a6a4a;color:#4ade80}.nai-mode-switch{display:flex;background:#0a0a12;border:1px solid #2a2a3a;border-radius:4px;overflow:hidden}.nai-mode-btn{padding:4px 10px;font-size:10px;color:#666;cursor:pointer;border:none;background:transparent}.nai-mode-btn.active{background:#1a2a3a;color:#4a9eff}.nai-body{padding:12px}.nai-actions{display:flex;gap:6px;margin-bottom:10px}.nai-btn{flex:1;padding:8px;border-radius:6px;font-size:11px;cursor:pointer;border:1px solid #2a2a3a;background:#12121a;color:#aaa;text-align:center}.nai-btn:hover{background:#1a1a28}.nai-btn.primary{background:linear-gradient(135deg,#1a3a5a,#2a1a4a);border-color:#3a4a6a;color:#4a9eff}.nai-btn.green{background:linear-gradient(135deg,#1a3a2a,#1a4a3a);border-color:#2a6a4a;color:#4ade80}.nai-btn.orange{background:linear-gradient(135deg,#3a2a1a,#4a3a1a);border-color:#6a4a2a;color:#fbbf24}.nai-btn.purple{background:linear-gradient(135deg,#2a1a3a,#3a1a4a);border-color:#5a3a6a;color:#a78bfa}.nai-btn.cyan{background:linear-gradient(135deg,#1a3a3a,#1a4a4a);border-color:#2a6a6a;color:#22d3ee}.nai-btn:disabled{opacity:0.5;cursor:not-allowed}.nai-btn.small{flex:none;padding:6px 10px;font-size:10px}.nai-status{padding:8px;margin-bottom:10px;border-radius:6px;font-size:11px;text-align:center;display:none}.nai-status.show{display:block}.nai-status.success{color:#4ade80;background:#1a2a1a}.nai-status.error{color:#f87171;background:#2a1a1a}.nai-status.loading{color:#4a9eff;background:#1a1a2a}.nai-status.warn{color:#fbbf24;background:#2a2a1a}.nai-img-wrap{display:none;margin-bottom:10px}.nai-img-wrap.show{display:block}.nai-img-wrap img{width:100%;border-radius:6px}.nai-img-btns{display:flex;gap:6px;margin-top:8px}.nai-basic{display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap}.nai-select{flex:1;min-width:70px;padding:6px 8px;background:#12121a;border:1px solid #2a2a3a;border-radius:4px;color:#ddd;font-size:10px}.nai-toolbar{display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap}.nai-panel-section{display:none;background:#0a0a12;border:1px solid #1a2a3a;border-radius:6px;padding:12px;margin-bottom:10px}.nai-panel-section.show{display:block}.nai-panel-title{color:#4a9eff;font-size:12px;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid #1a2a3a;display:flex;justify-content:space-between;align-items:center}.nai-presets{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:10px}.nai-preset{padding:10px;background:#12121a;border:1px solid #2a2a3a;border-radius:6px;cursor:pointer;text-align:center;position:relative}.nai-preset:hover{background:#1a1a28}.nai-preset.active{border-color:#4a9eff;background:#1a2a3a}.nai-preset-name{color:#ddd;font-size:11px}.nai-preset-desc{color:#666;font-size:9px;margin-top:4px}.nai-preset-edit{position:absolute;top:4px;right:4px;font-size:10px;color:#666;cursor:pointer;padding:2px}.nai-preset-edit:hover{color:#4a9eff}.nai-field{margin-bottom:12px}.nai-label{display:flex;justify-content:space-between;color:#666;font-size:10px;margin-bottom:4px}.nai-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}.nai-slider-wrap{flex:1;display:flex;align-items:center;gap:8px}.nai-slider{flex:1;-webkit-appearance:none;height:4px;background:#2a2a3a;border-radius:2px}.nai-slider::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;background:#4a9eff;border-radius:50%;cursor:pointer}.nai-slider-val{color:#4a9eff;font-size:11px;min-width:30px;text-align:right}.nai-switch{display:flex;align-items:center;gap:8px;cursor:pointer;padding:4px 0}.nai-switch.disabled{opacity:0.4;cursor:not-allowed}.nai-switch-track{width:36px;height:20px;background:#2a2a3a;border-radius:10px;position:relative}.nai-switch-track.on{background:#1a3a2a}.nai-switch-thumb{position:absolute;top:2px;left:2px;width:16px;height:16px;background:#666;border-radius:50%;transition:all 0.2s}.nai-switch-track.on .nai-switch-thumb{left:18px;background:#4ade80}.nai-switch-label{color:#888;font-size:11px}.nai-textarea{width:100%;padding:8px;background:#0a0a12;border:1px solid #2a2a3a;border-radius:4px;color:#ddd;font-size:11px;resize:vertical;min-height:50px;box-sizing:border-box;font-family:inherit}.nai-textarea:focus{outline:none;border-color:#4a9eff}.nai-input{width:100%;padding:6px 8px;background:#0a0a12;border:1px solid #2a2a3a;border-radius:4px;color:#ddd;font-size:11px;box-sizing:border-box}.nai-input:focus{outline:none;border-color:#4a9eff}.nai-orig{background:#12121a;border:1px solid #2a2a3a;border-radius:4px;padding:8px;color:#888;font-size:11px;max-height:60px;overflow-y:auto}.nai-github{margin-top:10px;padding:10px;background:#0a0a12;border:1px solid #1a2a3a;border-radius:6px}.nai-github-title{color:#888;font-size:10px;margin-bottom:8px;display:flex;align-items:center;gap:6px}.nai-github-status{width:8px;height:8px;border-radius:50%;background:#666}.nai-github-status.ok{background:#4ade80}.nai-github-status.loading{background:#4a9eff;animation:naiPulse 1s infinite}@keyframes naiPulse{50%{opacity:0.5}}.nai-github-btns{display:flex;gap:6px}.nai-log{background:#0a0a12;border:1px solid #2a2a3a;border-radius:4px;margin-top:10px;display:none;overflow:hidden}.nai-log.show{display:block}.nai-log-header{display:flex;justify-content:space-between;padding:6px 8px;cursor:pointer;background:#12121a}.nai-log-current{flex:1;font-family:monospace;font-size:10px;color:#888;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.nai-log-current.ok{color:#4ade80}.nai-log-current.err{color:#f87171}.nai-log-current.info{color:#4a9eff}.nai-log-detail{max-height:0;overflow:hidden}.nai-log.expanded .nai-log-detail{max-height:200px;overflow-y:auto}.nai-log-content{padding:8px;font-family:monospace;font-size:10px;border-top:1px solid #2a2a3a}.nai-log-line{color:#888}.nai-log-line.ok{color:#4ade80}.nai-log-line.err{color:#f87171}.nai-log-line.info{color:#4a9eff}.nai-dna-list{max-height:150px;overflow-y:auto;margin-bottom:10px}.nai-dna-item{display:flex;align-items:center;gap:8px;padding:8px;background:#12121a;border:1px solid #2a2a3a;border-radius:4px;margin-bottom:6px}.nai-dna-check{width:16px;height:16px;accent-color:#4a9eff}.nai-dna-info{flex:1;min-width:0}.nai-dna-name{color:#4a9eff;font-size:11px}.nai-dna-source{color:#a78bfa;font-size:9px}.nai-dna-preview{color:#666;font-size:9px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.nai-dna-btn{padding:4px 8px;font-size:9px;background:#1a1a28;border:1px solid #2a2a3a;border-radius:3px;color:#888;cursor:pointer}.nai-dna-btn.delete{color:#f87171}.nai-cloud-sync{margin-top:10px;padding-top:10px;border-top:1px solid #2a2a3a;display:flex;align-items:center;gap:8px}.nai-cloud-sync span{color:#666;font-size:10px}.nai-ai-panel{background:linear-gradient(135deg,#0a1520,#0a0a18);border:1px solid #1a3a4a;border-radius:6px;padding:12px;margin-bottom:10px;display:none}.nai-ai-panel.show{display:block}.nai-ai-title{color:#22d3ee;font-size:12px;margin-bottom:10px}.nai-focus-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:4px;margin-bottom:10px}.nai-focus-item{padding:5px 3px;background:#12121a;border:1px solid #2a2a3a;border-radius:4px;text-align:center;cursor:pointer;font-size:9px;color:#888}.nai-focus-item.active{background:#1a2a3a;border-color:#4a9eff;color:#4a9eff}.nai-focus-item .icon{font-size:12px;display:block}.nai-ai-context{background:#0a0a12;border:1px solid #2a2a3a;border-radius:4px;padding:8px;font-size:10px;color:#666;max-height:80px;overflow-y:auto}.nai-ai-result{background:#0a120a;border:1px solid #2a4a3a;border-radius:4px;padding:8px;margin-top:10px;display:none}.nai-ai-result.show{display:block}.nai-ai-result-title{color:#4ade80;font-size:10px;margin-bottom:6px}.nai-ai-result-prompt{color:#aaa;font-size:10px}.nai-sep{border-top:1px dashed #2a2a3a;margin:8px 0}.nai-radio{display:flex;align-items:center;gap:6px;cursor:pointer;padding:8px;background:#12121a;border:1px solid #2a2a3a;border-radius:4px;margin-bottom:6px}.nai-radio:hover{background:#1a1a28}.nai-radio.active{border-color:#4a9eff}.nai-radio.disabled{opacity:0.5;cursor:not-allowed}.nai-radio input{accent-color:#4a9eff}.nai-radio-label{color:#ddd;font-size:11px;flex:1}.nai-radio-status{font-size:9px;padding:2px 6px;border-radius:3px}.nai-radio-status.ok{color:#4ade80;background:#1a2a1a}.nai-radio-status.err{color:#666;background:#1a1a1a}.nai-section{margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid #1a2a3a}.nai-section:last-child{border-bottom:none}.nai-section-title{color:#888;font-size:11px;margin-bottom:10px}.nai-test-item{background:#12121a;border:1px solid #2a2a3a;border-radius:6px;padding:12px;margin-bottom:10px}.nai-test-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}.nai-test-name{color:#ddd;font-size:12px}.nai-test-status{font-size:10px;padding:2px 8px;border-radius:4px;background:#2a2a3a;color:#888}.nai-test-status.ok{background:#1a3a2a;color:#4ade80}.nai-test-status.err{background:#3a1a1a;color:#f87171}.nai-test-status.loading{background:#1a2a3a;color:#4a9eff}.nai-test-detail{font-size:10px;color:#666;margin-top:6px}.nai-test-speed{color:#4a9eff}.nai-model-list{max-height:200px;overflow-y:auto;border:1px solid #2a2a3a;border-radius:4px;margin-top:8px}.nai-model-item{padding:8px;border-bottom:1px solid #1a1a2a;cursor:pointer;font-size:11px;color:#888}.nai-model-item:hover{background:#1a1a28;color:#ddd}.nai-model-item.active{background:#1a2a3a;color:#4a9eff}.nai-dummy-hide{display:none!important}.nai-author{position:absolute;bottom:2px;right:6px;font-size:8px;color:#222;pointer-events:none}</style>\n\n<div class=\"nai-panel\" id=\"nai_{{RAND}}\">\n  <div class=\"nai-page show\" id=\"page_main_{{RAND}}\">\n    <div class=\"nai-header\">\n      <div class=\"nai-header-left\">\n        <span class=\"nai-eagle\">ğŸ¦…</span>\n        <span class=\"nai-title-text\">æ¸¡é¸¦ç”Ÿå›¾v2.3</span>\n      </div>\n      <div class=\"nai-conn-list\" id=\"conn_list_{{RAND}}\">\n        <div class=\"nai-conn-item\" id=\"conn_img_{{RAND}}\" title=\"ç‚¹å‡»è¿›å…¥è®¾ç½®\">\n          <span class=\"nai-conn-icon\">ğŸ–¼ï¸</span>\n          <span class=\"nai-conn-name\" id=\"conn_img_name_{{RAND}}\">-</span>\n          <span class=\"nai-conn-dot\" id=\"conn_img_dot_{{RAND}}\"></span>\n        </div>\n        <div class=\"nai-conn-item\" id=\"conn_llm_{{RAND}}\" title=\"ç‚¹å‡»è¿›å…¥è®¾ç½®\">\n          <span class=\"nai-conn-icon\">ğŸ¤–</span>\n          <span class=\"nai-conn-name\" id=\"conn_llm_name_{{RAND}}\">-</span>\n          <span class=\"nai-conn-dot\" id=\"conn_llm_dot_{{RAND}}\"></span>\n        </div>\n        <div class=\"nai-conn-item\" id=\"conn_gh_{{RAND}}\" title=\"ç‚¹å‡»è¿›å…¥è®¾ç½®\">\n          <span class=\"nai-conn-icon\">ğŸ“¦</span>\n          <span class=\"nai-conn-name\" id=\"conn_gh_name_{{RAND}}\">-</span>\n          <span class=\"nai-conn-dot\" id=\"conn_gh_dot_{{RAND}}\"></span>\n        </div>\n      </div>\n    </div>\n    <div class=\"nai-scene-bar\">\n      <span class=\"nai-scene-icon\">ğŸ“</span>\n      <span class=\"nai-scene-id\" id=\"scene_id_{{RAND}}\" title=\"ç‚¹å‡»å¤åˆ¶\">$1</span>\n    </div>\n    <div class=\"nai-ctrl-bar\">\n      <div class=\"nai-ctrl-left\">\n        <button class=\"nai-dummy-btn\" id=\"dummy_btn_{{RAND}}\">ğŸ£å‘†ç“œ</button>\n        <div class=\"nai-mode-switch\" id=\"mode_wrap_{{RAND}}\">\n          <button class=\"nai-mode-btn active\" id=\"mode_m_{{RAND}}\">ğŸ“æ‰‹åŠ¨</button>\n          <button class=\"nai-mode-btn\" id=\"mode_a_{{RAND}}\">ğŸ¤–æ™ºèƒ½</button>\n        </div>\n      </div>\n      <button class=\"nai-settings-btn\" id=\"settings_btn_{{RAND}}\">âš™ï¸</button>\n    </div>\n    <div class=\"nai-body\">\n      <div class=\"nai-actions\">\n        <button class=\"nai-btn\" id=\"check_{{RAND}}\">ğŸ”æ£€æŸ¥</button>\n        <button class=\"nai-btn primary\" id=\"gen_{{RAND}}\">âœ¨ç”Ÿæˆ</button>\n        <button class=\"nai-btn orange\" id=\"regen_{{RAND}}\">ğŸ”„é‡æ–°</button>\n      </div>\n      <div class=\"nai-status\" id=\"status_{{RAND}}\"></div>\n      <div class=\"nai-img-wrap\" id=\"imgwrap_{{RAND}}\"><img id=\"img_{{RAND}}\"><div class=\"nai-img-btns\" id=\"imgbtns_{{RAND}}\"><button class=\"nai-btn cyan small\" id=\"copyimg_{{RAND}}\">ğŸ“‹å¤åˆ¶</button><button class=\"nai-btn small\" id=\"download_{{RAND}}\">ğŸ’¾ä¸‹è½½</button><button class=\"nai-btn purple small\" id=\"img2video_{{RAND}}\">ğŸ¬è½¬è§†é¢‘</button></div></div>\n      <div class=\"nai-video-wrap\" id=\"vidwrap_{{RAND}}\" style=\"display:none;margin-top:8px;padding:8px;border:1px solid #1a2a3a;border-radius:6px;background:#0a0a12\">\n        <div style=\"display:flex;align-items:center;justify-content:space-between;gap:8px\">\n          <div style=\"color:#aaa;font-size:11px\">ğŸï¸ è§†é¢‘é¢„è§ˆï¼ˆæœ¬åœ°ç¼“å­˜ï¼‰</div>\n          <button class=\"nai-btn small\" id=\"copyvideo_{{RAND}}\">ğŸ“‹å¤åˆ¶è§†é¢‘URL</button>\n        </div>\n        <video id=\"video_{{RAND}}\" controls style=\"width:100%;margin-top:6px;border-radius:6px;background:#000\"></video>\n        <div id=\"videourl_{{RAND}}\" style=\"margin-top:6px;color:#666;font-size:10px;word-break:break-all\"></div>\n      </div>\n      <div class=\"nai-ai-panel\" id=\"ai_panel_{{RAND}}\">\n        <div class=\"nai-ai-title\">ğŸ¤– AIæ™ºèƒ½ä¼˜åŒ–</div>\n        <div class=\"nai-field\"><label class=\"nai-label\">å…³æ³¨é‡ç‚¹</label><div class=\"nai-focus-grid\" id=\"focus_{{RAND}}\"><div class=\"nai-focus-item active\" data-f=\"expression\"><span class=\"icon\">ğŸ˜Š</span>è¡¨æƒ…</div><div class=\"nai-focus-item active\" data-f=\"action\"><span class=\"icon\">ğŸƒ</span>åŠ¨ä½œ</div><div class=\"nai-focus-item\" data-f=\"clothing\"><span class=\"icon\">ğŸ‘—</span>æœè£…</div><div class=\"nai-focus-item\" data-f=\"scene\"><span class=\"icon\">ğŸ </span>åœºæ™¯</div><div class=\"nai-focus-item\" data-f=\"lighting\"><span class=\"icon\">ğŸ’¡</span>å…‰å½±</div><div class=\"nai-focus-item\" data-f=\"mood\"><span class=\"icon\">ğŸ­</span>æ°›å›´</div><div class=\"nai-focus-item\" data-f=\"pose\"><span class=\"icon\">ğŸ§˜</span>å§¿æ€</div><div class=\"nai-focus-item\" data-f=\"interaction\"><span class=\"icon\">ğŸ‘¥</span>äº’åŠ¨</div></div></div>\n        <div class=\"nai-field\"><label class=\"nai-label\">é¢å¤–æŒ‡ä»¤</label><input type=\"text\" class=\"nai-input\" id=\"ai_extra_{{RAND}}\" placeholder=\"ä¾‹å¦‚ï¼šçªå‡ºæ¸©é¦¨æ„Ÿã€é€†å…‰ã€å®Œå…¨é‡å†™...\"></div>\n        <div class=\"nai-row\" style=\"margin-bottom:10px\"><button class=\"nai-btn cyan\" id=\"ai_preview_{{RAND}}\">ğŸ¤–ä¼˜åŒ–</button><button class=\"nai-btn small\" id=\"ai_apply_{{RAND}}\">âœ“åº”ç”¨</button></div>\n        <div class=\"nai-field\"><label class=\"nai-label\"><span>ä¸Šä¸‹æ–‡</span><span id=\"ai_info_{{RAND}}\" style=\"color:#555\">0æ¡/0å­—</span></label><div class=\"nai-ai-context\" id=\"ai_ctx_{{RAND}}\">ç‚¹å‡»ä¼˜åŒ–åè¯»å–...</div></div>\n        <div class=\"nai-ai-result\" id=\"ai_result_{{RAND}}\"><div class=\"nai-ai-result-title\">âœ¨ä¼˜åŒ–ç»“æœ</div><div class=\"nai-ai-result-prompt\" id=\"ai_prompt_{{RAND}}\"></div></div>\n      </div>\n      <div class=\"nai-basic\" id=\"basic_{{RAND}}\">\n        <select class=\"nai-select\" id=\"model_{{RAND}}\"><option value=\"nai-diffusion-4-5-curated\" selected>V4.5 Curated</option><option value=\"nai-diffusion-4-5-full\">V4.5 Full</option><option value=\"nai-diffusion-4-curated-preview\">V4 Curated</option><option value=\"nai-diffusion-4-full\">V4 Full</option><option value=\"nai-diffusion-3\">V3 Anime</option><option value=\"nai-diffusion-furry-3\">V3 Furry</option></select>\n        <select class=\"nai-select\" id=\"size_{{RAND}}\"><option value=\"832x832\">832Â²</option><option value=\"1024x1024\" selected>1024Â²</option><option value=\"1216x832\">æ¨ª1216Ã—832</option><option value=\"832x1216\">ç«–832Ã—1216</option></select>\n        <select class=\"nai-select\" id=\"comp_{{RAND}}\"><option value=\"upper\">åŠèº«</option><option value=\"cowboy\">ç‰›ä»”</option><option value=\"portrait\">å¤´åƒ</option><option value=\"full\">å…¨èº«</option></select>\n      </div>\n      <div class=\"nai-toolbar\" id=\"toolbar_{{RAND}}\">\n        <button class=\"nai-btn\" id=\"btn_dna_{{RAND}}\">ğŸ‘¤DNA</button>\n        <button class=\"nai-btn\" id=\"btn_style_{{RAND}}\">ğŸ¨ç”»é£</button>\n        <button class=\"nai-btn\" id=\"btn_adv_{{RAND}}\">âš™ï¸é«˜çº§</button>\n        <button class=\"nai-btn\" id=\"btn_prompt_{{RAND}}\">ğŸ“æç¤ºè¯</button>\n      </div>\n      <div class=\"nai-panel-section\" id=\"p_dna_{{RAND}}\">\n        <div class=\"nai-panel-title\"><span>ğŸ‘¤è§’è‰²DNA</span><span style=\"font-size:9px;color:#666\">å‹¾é€‰æ³¨å…¥</span></div>\n        <div class=\"nai-dna-list\" id=\"dna_list_{{RAND}}\"></div>\n        <button class=\"nai-btn green\" id=\"dna_add_btn_{{RAND}}\">â• æ·»åŠ è§’è‰²</button>\n        <div class=\"nai-cloud-sync\"><span>â˜ï¸åŒæ­¥</span><button class=\"nai-btn small\" id=\"dna_pull_{{RAND}}\">â¬‡ï¸æ‹‰å–</button><button class=\"nai-btn small purple\" id=\"dna_push_{{RAND}}\">â¬†ï¸æ¨é€</button></div>\n      </div>\n      <div class=\"nai-panel-section\" id=\"p_style_{{RAND}}\">\n        <div class=\"nai-panel-title\"><span>ğŸ¨ç”»é£é¢„è®¾</span><button class=\"nai-btn small\" id=\"reset_presets_{{RAND}}\">ğŸ”„æ¢å¤é»˜è®¤</button></div>\n        <div class=\"nai-presets\" id=\"presets_{{RAND}}\"></div>\n        <button class=\"nai-btn purple\" id=\"add_preset_btn_{{RAND}}\">â• æ–°å»ºé¢„è®¾</button>\n        <div class=\"nai-field\" style=\"margin-top:12px\"><label class=\"nai-label\">é£æ ¼åç¼€</label><textarea class=\"nai-textarea\" id=\"suffix_{{RAND}}\" rows=\"2\"></textarea></div>\n        <div class=\"nai-field\"><label class=\"nai-label\">è´Ÿé¢è¯</label><textarea class=\"nai-textarea\" id=\"neg_{{RAND}}\" rows=\"2\"></textarea></div>\n        <div class=\"nai-cloud-sync\"><span>â˜ï¸åŒæ­¥</span><button class=\"nai-btn small\" id=\"preset_pull_{{RAND}}\">â¬‡ï¸æ‹‰å–</button><button class=\"nai-btn small purple\" id=\"preset_push_{{RAND}}\">â¬†ï¸æ¨é€</button></div>\n      </div>\n      <div class=\"nai-panel-section\" id=\"p_adv_{{RAND}}\">\n        <div class=\"nai-panel-title\"><span>âš™ï¸é«˜çº§è®¾ç½®</span><span id=\"v45warn_{{RAND}}\" style=\"display:none;font-size:9px;color:#fbbf24;background:#3a2a1a;padding:2px 6px;border-radius:3px\">V4.5é™åˆ¶</span></div>\n        <div class=\"nai-field\"><label class=\"nai-label\">é‡‡æ ·å™¨</label><select class=\"nai-select\" id=\"sampler_{{RAND}}\"><option value=\"k_euler_ancestral\" selected>â˜…Euler Ancestral</option><option value=\"k_euler\">Euler</option><option value=\"k_dpmpp_2s_ancestral\">DPM++2S A</option><option value=\"k_dpmpp_2m_sde\">DPM++2M SDE</option><option value=\"k_dpmpp_2m\">DPM++2M</option><option value=\"k_dpmpp_sde\">DPM++SDE</option></select></div>\n        <div class=\"nai-field\"><label class=\"nai-label\">æ­¥æ•°</label><div class=\"nai-slider-wrap\"><input type=\"range\" class=\"nai-slider\" id=\"steps_{{RAND}}\" min=\"10\" max=\"50\" value=\"28\"><span class=\"nai-slider-val\" id=\"steps_v_{{RAND}}\">28</span></div></div>\n        <div class=\"nai-field\"><label class=\"nai-label\">CFG</label><div class=\"nai-slider-wrap\"><input type=\"range\" class=\"nai-slider\" id=\"scale_{{RAND}}\" min=\"1\" max=\"10\" step=\"0.5\" value=\"6\"><span class=\"nai-slider-val\" id=\"scale_v_{{RAND}}\">6</span></div></div>\n        <div class=\"nai-row\"><div class=\"nai-switch\" id=\"smea_{{RAND}}\"><div class=\"nai-switch-track on\"><div class=\"nai-switch-thumb\"></div></div><span class=\"nai-switch-label\">SMEA</span></div><div class=\"nai-switch\" id=\"variety_{{RAND}}\"><div class=\"nai-switch-track\"><div class=\"nai-switch-thumb\"></div></div><span class=\"nai-switch-label\">Variety</span></div></div>\n      </div>\n      <div class=\"nai-panel-section\" id=\"p_prompt_{{RAND}}\">\n        <div class=\"nai-panel-title\">ğŸ“æç¤ºè¯</div>\n        <div class=\"nai-field\"><label class=\"nai-label\">AIåŸå§‹</label><div class=\"nai-orig\" id=\"orig_{{RAND}}\">$2</div></div>\n        <div class=\"nai-field\"><label class=\"nai-label\">æ­£å‘</label><textarea class=\"nai-textarea\" id=\"prompt_{{RAND}}\" rows=\"3\"></textarea></div>\n      </div>\n      <div class=\"nai-github\" id=\"github_{{RAND}}\"><div class=\"nai-github-title\"><span class=\"nai-github-status\" id=\"ghstatus_{{RAND}}\"></span><span>GitHubç¼“å­˜</span><span id=\"ghtext_{{RAND}}\" style=\"color:#666;margin-left:auto\">-</span></div><div class=\"nai-github-btns\"><button class=\"nai-btn small\" id=\"ghcheck_{{RAND}}\">ğŸ”æ£€æŸ¥</button><button class=\"nai-btn small purple\" id=\"ghupload_{{RAND}}\">â˜ï¸ä¸Šä¼ </button><button class=\"nai-btn small orange\" id=\"ghdelete_{{RAND}}\">ğŸ—‘ï¸åˆ é™¤</button></div></div>\n      <div class=\"nai-log\" id=\"log_{{RAND}}\"><div class=\"nai-log-header\" id=\"logh_{{RAND}}\"><div class=\"nai-log-current\" id=\"logc_{{RAND}}\">ç­‰å¾…...</div><span id=\"loge_{{RAND}}\">â–¼</span></div><div class=\"nai-log-detail\"><div class=\"nai-log-content\" id=\"logd_{{RAND}}\"></div></div></div>\n    </div>\n    <span class=\"nai-author\">by æ¸¡é¸¦4455</span>\n  </div>\n  <div class=\"nai-page\" id=\"page_settings_{{RAND}}\">\n    <div class=\"nai-page-header\"><button class=\"nai-back-btn\" id=\"back_settings_{{RAND}}\">â† è¿”å›</button><span class=\"nai-page-title\">âš™ï¸ è®¾ç½®</span></div>\n    <div class=\"nai-page-body\">\n      <div class=\"nai-section\"><div class=\"nai-section-title\">ğŸ–¼ï¸ ç”Ÿå›¾æ¨¡å‹</div><div id=\"img_models_{{RAND}}\"></div></div>\n      <div class=\"nai-section\"><div class=\"nai-section-title\">ğŸ¤– LLMæ¨¡å‹ <button class=\"nai-btn small\" id=\"fetch_llm_{{RAND}}\">ğŸ“¥æ‹‰å–æ¨¡å‹</button></div><div id=\"llm_models_{{RAND}}\"></div><div class=\"nai-model-list\" id=\"llm_list_{{RAND}}\" style=\"display:none\"></div></div>\n      <div class=\"nai-section\"><div class=\"nai-section-title\">ğŸ“¦ GitHub</div><div class=\"nai-row\"><span id=\"gh_text_{{RAND}}\" style=\"color:#888;font-size:11px\">-</span><button class=\"nai-btn small\" id=\"gh_check_{{RAND}}\">ğŸ”æ£€æŸ¥</button></div></div>\n      <div class=\"nai-section\"><div class=\"nai-section-title\">ğŸ¬ è§†é¢‘ä¸­è½¬</div><div class=\"nai-row\" style=\"gap:8px;flex-wrap:wrap\"><input id=\"proxy_url_{{RAND}}\" placeholder=\"http://å¯è®¿é—®çš„ä¸­è½¬åœ°å€:8787\" style=\"flex:1;min-width:200px;background:#0a0a12;border:1px solid #1a2a3a;color:#aaa;border-radius:6px;padding:6px 8px;font-size:11px\"><button class=\"nai-btn small\" id=\"proxy_save_{{RAND}}\">ğŸ’¾ä¿å­˜</button></div><div style=\"color:#666;font-size:10px;margin-top:6px\">æ‰‹æœºç«¯è¯·å¡«â€œæ‰‹æœºèƒ½è®¿é—®åˆ°â€çš„åœ°å€ï¼šåŒWiFiå¯ç”¨æœåŠ¡å™¨å±€åŸŸç½‘IPï¼›æˆ–ç”¨Tailscale/å†…ç½‘ç©¿é€ã€‚</div></div>\n      <div class=\"nai-section\"><div class=\"nai-section-title\">ğŸ¨ é»˜è®¤é¢„è®¾</div><select class=\"nai-select\" id=\"default_preset_{{RAND}}\" style=\"width:100%\"></select></div>\n      <div class=\"nai-section\"><button class=\"nai-btn cyan\" id=\"goto_test_{{RAND}}\" style=\"width:100%\">ğŸ”§ è¿é€šæ€§æµ‹è¯•</button></div>\n    </div>\n    <span class=\"nai-author\">æ¸¡é¸¦4455 Â© 2026</span>\n  </div>\n  <div class=\"nai-page\" id=\"page_test_{{RAND}}\">\n    <div class=\"nai-page-header\"><button class=\"nai-back-btn\" id=\"back_test_{{RAND}}\">â† è¿”å›</button><span class=\"nai-page-title\">ğŸ”§ è¿é€šæ€§æµ‹è¯•</span></div>\n    <div class=\"nai-page-body\">\n      <div class=\"nai-test-item\">\n        <div class=\"nai-test-title\"><span class=\"nai-test-name\">ğŸ–¼ï¸ NAIç”Ÿå›¾API</span><span class=\"nai-test-status\" id=\"test_nai_status_{{RAND}}\">å¾…æµ‹è¯•</span></div>\n        <div class=\"nai-test-detail\" id=\"test_nai_detail_{{RAND}}\">ç‚¹å‡»æµ‹è¯•æŒ‰é’®æ£€æŸ¥è¿é€šæ€§</div>\n        <button class=\"nai-btn small\" id=\"test_nai_{{RAND}}\" style=\"margin-top:8px\">ğŸ”æµ‹è¯•</button>\n      </div>\n      <div class=\"nai-test-item\">\n        <div class=\"nai-test-title\"><span class=\"nai-test-name\">ğŸ¤– LLMæ™ºèƒ½API</span><span class=\"nai-test-status\" id=\"test_llm_status_{{RAND}}\">å¾…æµ‹è¯•</span></div>\n        <div class=\"nai-test-detail\" id=\"test_llm_detail_{{RAND}}\">ç‚¹å‡»æµ‹è¯•æŒ‰é’®æ£€æŸ¥è¿é€šæ€§å’Œé€Ÿåº¦</div>\n        <button class=\"nai-btn small\" id=\"test_llm_{{RAND}}\" style=\"margin-top:8px\">ğŸ”æµ‹è¯•</button>\n      </div>\n      <div class=\"nai-test-item\">\n        <div class=\"nai-test-title\"><span class=\"nai-test-name\">ğŸ“¦ GitHubä»“åº“</span><span class=\"nai-test-status\" id=\"test_gh_status_{{RAND}}\">å¾…æµ‹è¯•</span></div>\n        <div class=\"nai-test-detail\" id=\"test_gh_detail_{{RAND}}\">ç‚¹å‡»æµ‹è¯•æŒ‰é’®æ£€æŸ¥ä»“åº“æƒé™</div>\n        <button class=\"nai-btn small\" id=\"test_gh_{{RAND}}\" style=\"margin-top:8px\">ğŸ”æµ‹è¯•</button>\n      </div>\n      <button class=\"nai-btn primary\" id=\"test_all_{{RAND}}\" style=\"margin-top:12px\">ğŸš€ å…¨éƒ¨æµ‹è¯•</button>\n    </div>\n  </div>\n  <div class=\"nai-page\" id=\"page_preset_{{RAND}}\">\n    <div class=\"nai-page-header\"><button class=\"nai-back-btn\" id=\"back_preset_{{RAND}}\">â† è¿”å›</button><span class=\"nai-page-title\" id=\"edit_title_{{RAND}}\">ğŸ¨ ç¼–è¾‘é¢„è®¾</span></div>\n    <div class=\"nai-page-body\">\n      <input type=\"hidden\" id=\"edit_id_{{RAND}}\">\n      <div class=\"nai-field\"><label class=\"nai-label\">åç§°</label><input type=\"text\" class=\"nai-input\" id=\"edit_name_{{RAND}}\"></div>\n      <div class=\"nai-field\"><label class=\"nai-label\">åç¼€</label><textarea class=\"nai-textarea\" id=\"edit_suffix_{{RAND}}\" rows=\"3\"></textarea></div>\n      <div class=\"nai-field\"><label class=\"nai-label\">è´Ÿé¢è¯</label><textarea class=\"nai-textarea\" id=\"edit_neg_{{RAND}}\" rows=\"2\"></textarea></div>\n      <div class=\"nai-field\"><label class=\"nai-label\">é‡‡æ ·å™¨</label><select class=\"nai-select\" id=\"edit_sampler_{{RAND}}\"><option value=\"k_euler_ancestral\">â˜…Euler Ancestral</option><option value=\"k_euler\">Euler</option><option value=\"k_dpmpp_2s_ancestral\">DPM++2S A</option><option value=\"k_dpmpp_2m_sde\">DPM++2M SDE</option><option value=\"k_dpmpp_2m\">DPM++2M</option><option value=\"k_dpmpp_sde\">DPM++SDE</option></select></div>\n      <div class=\"nai-field\"><label class=\"nai-label\">æ­¥æ•°: <span id=\"edit_steps_v_{{RAND}}\">28</span></label><input type=\"range\" class=\"nai-slider\" id=\"edit_steps_{{RAND}}\" min=\"10\" max=\"50\" value=\"28\" style=\"width:100%\"></div>\n      <div class=\"nai-field\"><label class=\"nai-label\">CFG: <span id=\"edit_scale_v_{{RAND}}\">6</span></label><input type=\"range\" class=\"nai-slider\" id=\"edit_scale_{{RAND}}\" min=\"1\" max=\"10\" step=\"0.5\" value=\"6\" style=\"width:100%\"></div>\n      <div class=\"nai-row\" style=\"margin-bottom:12px\"><div class=\"nai-switch\" id=\"edit_smea_{{RAND}}\"><div class=\"nai-switch-track on\"><div class=\"nai-switch-thumb\"></div></div><span class=\"nai-switch-label\">SMEA</span></div><div class=\"nai-switch\" id=\"edit_variety_{{RAND}}\"><div class=\"nai-switch-track\"><div class=\"nai-switch-thumb\"></div></div><span class=\"nai-switch-label\">Variety</span></div></div>\n      <div class=\"nai-row\"><button class=\"nai-btn orange\" id=\"edit_del_{{RAND}}\">ğŸ—‘ï¸åˆ é™¤</button><button class=\"nai-btn green\" id=\"edit_save_{{RAND}}\">ğŸ’¾ ä¿å­˜</button></div>\n    </div>\n  </div>\n  <div class=\"nai-page\" id=\"page_dna_{{RAND}}\">\n    <div class=\"nai-page-header\"><button class=\"nai-back-btn\" id=\"back_dna_{{RAND}}\">â† è¿”å›</button><span class=\"nai-page-title\" id=\"dna_title_{{RAND}}\">ğŸ‘¤ æ·»åŠ è§’è‰²</span></div>\n    <div class=\"nai-page-body\">\n      <input type=\"hidden\" id=\"dna_edit_name_{{RAND}}\">\n      <div class=\"nai-field\"><label class=\"nai-label\">è§’è‰²å</label><input type=\"text\" class=\"nai-input\" id=\"dna_name_{{RAND}}\"></div>\n      <div class=\"nai-field\"><label class=\"nai-label\"><span>æ¥æºæ ‡ç­¾</span><span style=\"color:#555\">çŸ¥åè§’è‰²å¡«å†™</span></label><input type=\"text\" class=\"nai-input\" id=\"dna_source_{{RAND}}\" placeholder=\"march 7th, honkai: star rail\"></div>\n      <div class=\"nai-field\"><label class=\"nai-label\">å¤–è²Œ</label><textarea class=\"nai-textarea\" id=\"dna_appear_{{RAND}}\" rows=\"3\" placeholder=\"pink hair, blue eyes\"></textarea></div>\n      <div class=\"nai-row\"><button class=\"nai-btn orange\" id=\"dna_del_{{RAND}}\" style=\"display:none\">ğŸ—‘ï¸åˆ é™¤</button><button class=\"nai-btn green\" id=\"dna_save_{{RAND}}\">ğŸ’¾ ä¿å­˜</button></div>\n    </div>\n  </div>\n</div>\n\n<script>\n(function(){\nvar uid='{{RAND}}',card=document.getElementById('nai_'+uid);if(!card||card.dataset.init)return;card.dataset.init='1';\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// â–ˆâ–ˆ  é…ç½®åŒº - ç”Ÿå›¾æ¨¡å‹ï¼ˆ3ä¸ªä½ç½®ï¼‰\n// â–ˆâ–ˆ  type: 'nai' = NovelAIä¸“ç”¨\n// â–ˆâ–ˆ  type: 'chat_image' = èŠå¤©å¼ç”Ÿå›¾ï¼ˆå¦‚Geminiï¼‰\n// â–ˆâ–ˆ  type: 'image_gen' = æ ‡å‡†å›¾ç‰‡ç”ŸæˆAPIï¼ˆ/v1/images/generationsï¼‰\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nvar IMG_MODELS = [\n  {\n    id: 'nai',\n    name: 'NovelAI',\n    type: 'nai',\n    token: ''\n  },\n  {\n    id: 'c1',\n    name: 'è‡ªå®šä¹‰1',\n    type: 'chat_image',\n    url: '',\n    key: '',\n    model: ''\n  },\n  {\n    id: 'c2',\n    name: 'è‡ªå®šä¹‰2',\n    type: 'image_gen',\n    url: '',\n    key: '',\n    model: ''\n  }\n];\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// â–ˆâ–ˆ  é…ç½®åŒº - LLMæ¨¡å‹ï¼ˆ3ä¸ªä½ç½®ï¼Œç”¨äºæ™ºèƒ½æ¨¡å¼ï¼‰\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nvar LLM_MODELS = [\n  {\n    id: 'l1',\n    name: 'è‡ªå®šä¹‰LLM1',\n    url: '',\n    key: '',\n    model: ''\n  },\n  {\n    id: 'l2',\n    name: 'è‡ªå®šä¹‰LLM2',\n    url: '',\n    key: '',\n    model: ''\n  },\n  {\n    id: 'l3',\n    name: 'è‡ªå®šä¹‰LLM3',\n    url: '',\n    key: '',\n    model: ''\n  }\n];\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// â–ˆâ–ˆ  é…ç½®åŒº - GitHub\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nvar GH_TOKEN = '';\nvar GH_OWNER = '';\nvar GH_REPO = '';\nvar GH_BRANCH = 'main';\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// â–ˆâ–ˆ  é…ç½®åŒº - é»˜è®¤è®¾ç½®\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nvar DEF_PRESET = 'anime';\nvar CUR_IMG = 'nai';\nvar CUR_LLM = 'l1';\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// â–ˆâ–ˆ  å†…ç½®é¢„è®¾ï¼ˆ5ä¸ªç”»é£é¢„è®¾ï¼Œæ¯ä¸ªé¢„è®¾åŒ…å«ä¸“å±è´Ÿé¢è¯ï¼‰\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nvar BUILTIN = {\n  anime: {\n    name: 'ç²¾è‡´åŠ¨æ¼«',\n    sampler: 'k_euler_ancestral',\n    steps: 28,\n    scale: 6,\n    noise: 'native',\n    smea: true,\n    variety: false,\n    suffix: '{{{masterpiece}}}, {best quality}, amazing quality, very aesthetic, anime style, detailed',\n    neg: 'lowres, bad anatomy, bad hands, text, error, missing fingers, worst quality, low quality, jpeg artifacts, signature, watermark, blurry, poorly drawn, bad face, distorted face'\n  },\n  glossy: {\n    name: 'æ¸…é€æ¶¦æ³½',\n    sampler: 'k_dpmpp_2m',\n    steps: 28,\n    scale: 6,\n    noise: 'native',\n    smea: true,\n    variety: false,\n    suffix: '{artist:luohuarumeng}, {artist:ciloranko}, clean style, soft lighting, {glossy skin}, {wet skin}, smooth skin, delicate features, {detailed eyes}, refined details, beautiful lighting, elegant',\n    neg: 'lowres, bad anatomy, bad hands, worst quality, low quality, blurry, poorly drawn, bad face, distorted face, dry skin, rough skin, matte skin, dirty, messy, gritty, dark theme'\n  },\n  game: {\n    name: 'æ¸¸æˆç«‹ç»˜',\n    sampler: 'k_dpmpp_2m',\n    steps: 28,\n    scale: 7,\n    noise: 'native',\n    smea: true,\n    variety: false,\n    suffix: '{artist:lack}, {artist:rella}, {artist:neco}, official art, game cg, vibrant colors, high contrast, sharp lines, clean lineart, intricate details, dynamic, glossy',\n    neg: 'lowres, bad anatomy, bad hands, worst quality, low quality, blurry, poorly drawn, bad face, distorted face, dull colors, muted colors, soft lines, sketchy, watercolor, painterly, messy background'\n  },\n  tension: {\n    name: 'è‚¢ä½“å¼ åŠ›',\n    sampler: 'k_euler_ancestral',\n    steps: 28,\n    scale: 6.5,\n    noise: 'karras',\n    smea: true,\n    variety: false,\n    suffix: '{artist:miazi}, detailed, high quality, {dynamic pose}, {glistening skin}, {sweat}, dramatic angle, expressive face, detailed anatomy, soft shading',\n    neg: 'lowres, bad anatomy, bad hands, worst quality, low quality, blurry, poorly drawn, bad face, distorted face, stiff pose, static, flat lighting, dry skin, simple background'\n  },\n  impasto: {\n    name: 'ç²¾è‡´åšæ¶‚',\n    sampler: 'k_euler',\n    steps: 28,\n    scale: 7,\n    noise: 'karras',\n    smea: true,\n    variety: false,\n    suffix: '{artist:ratatatat74}, detailed, high quality, {{{glistening skin}}}, {{sweat}}, {wet skin}, {oily skin}, {detailed skin}, [skin texture], {{dramatic lighting}}, {{high contrast}}, {volumetric light}, {rim lighting}, {warm lighting}, soft shading, {detailed background}',\n    neg: 'lowres, bad anatomy, bad hands, worst quality, low quality, blurry, poorly drawn, bad face, distorted face, flat lighting, flat shading, cel shading, simple shading, dry skin, matte skin, soft lighting, overexposed, washed out, sketch, lineart, outline'\n  }\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// â–ˆâ–ˆ  æ„å›¾æ˜ å°„\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nvar COMP = {\n  portrait: 'portrait, face focus',\n  upper: 'upper body',\n  cowboy: 'cowboy shot',\n  full: 'full body'\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// â–ˆâ–ˆ  è¿é€šçŠ¶æ€ç®¡ç†\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nvar connStatus = {img:'unknown',llm:'unknown',gh:'unknown'};\nfunction loadConnStatus(){try{var s=localStorage.getItem('nai_conn');if(s)connStatus=JSON.parse(s);}catch(e){}}\nfunction saveConnStatus(){localStorage.setItem('nai_conn',JSON.stringify(connStatus));}\nfunction updateConnDot(type,status){connStatus[type]=status;saveConnStatus();var dot=$('conn_'+type+'_dot');if(dot){dot.className='nai-conn-dot';if(status==='ok')dot.classList.add('ok');else if(status==='err')dot.classList.add('err');else if(status==='loading')dot.classList.add('loading');}}\nfunction updateConnName(type,name){var el=$('conn_'+type+'_name');if(el)el.textContent=name||'-';}\nloadConnStatus();\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// â–ˆâ–ˆ  é…ç½®åŒºç»“æŸ\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nvar sceneId='$1',curPreset=DEF_PRESET,curB64='',curGhUrl='',curDataUrl='',cachedTok=null,isOp=false,isAi=false,aiPrompt='',isDummy=false;\n\nvar $=function(id){return document.getElementById(id+'_'+uid);};\nfunction showPage(name){card.querySelectorAll('.nai-page').forEach(function(p){p.classList.remove('show');});$('page_'+name).classList.add('show');}\n\nvar origEl=$('orig'),rawText=origEl?origEl.textContent.trim():'';\nvar modeM=$('mode_m'),modeA=$('mode_a'),aiPanel=$('ai_panel'),modeWrap=$('mode_wrap');\nvar settingsBtn=$('settings_btn'),backSettings=$('back_settings');\nvar backPreset=$('back_preset'),backDna=$('back_dna'),backTest=$('back_test');\nvar dummyBtn=$('dummy_btn');\nvar sceneIdEl=$('scene_id');\nvar focusEl=$('focus'),aiExtra=$('ai_extra'),aiCtx=$('ai_ctx'),aiInfo=$('ai_info');\nvar aiPreview=$('ai_preview'),aiApply=$('ai_apply'),aiResult=$('ai_result'),aiPromptEl=$('ai_prompt');\nvar checkBtn=$('check'),genBtn=$('gen'),regenBtn=$('regen'),copyBtn=$('copyimg'),dlBtn=$('download');\nvar img2videoBtn=$('img2video'),vidWrap=$('vidwrap'),videoEl=$('video'),copyVideoBtn=$('copyvideo'),videoUrlEl=$('videourl');\nvar proxyUrlInput=$('proxy_url'),proxySaveBtn=$('proxy_save');\nif(proxyUrlInput){proxyUrlInput.value=(localStorage.getItem('nai_proxy_url')||PROXY_URL||'');}\nif(proxySaveBtn){proxySaveBtn.onclick=function(){var v=(proxyUrlInput?proxyUrlInput.value:'').trim();if(!v){showStatus('âš è¯·è¾“å…¥ä¸­è½¬åœ°å€','warn');return;}localStorage.setItem('nai_proxy_url',v);PROXY_URL=v;showStatus('âœ“å·²ä¿å­˜ä¸­è½¬åœ°å€','success');};}\n\nvar PROXY_URL=(localStorage.getItem('nai_proxy_url')||'http://127.0.0.1:8787');\nfunction getProxyUrl(){return (localStorage.getItem('nai_proxy_url')||PROXY_URL||'').replace(/\\/+$/,'');}\n\n\nvar statusEl=$('status'),imgWrap=$('imgwrap'),imgEl=$('img'),imgBtns=$('imgbtns');\nvar modelSel=$('model'),sizeSel=$('size'),compSel=$('comp'),basicEl=$('basic');\nvar btnDna=$('btn_dna'),btnStyle=$('btn_style'),btnAdv=$('btn_adv'),btnPrompt=$('btn_prompt'),toolbarEl=$('toolbar');\nvar pDna=$('p_dna'),pStyle=$('p_style'),pAdv=$('p_adv'),pPrompt=$('p_prompt');\nvar dnaList=$('dna_list'),dnaAddBtn=$('dna_add_btn');\nvar dnaPull=$('dna_pull'),dnaPush=$('dna_push');\nvar presetsEl=$('presets'),suffixEl=$('suffix'),negEl=$('neg');\nvar addPresetBtn=$('add_preset_btn'),resetPresetsBtn=$('reset_presets');\nvar presetPull=$('preset_pull'),presetPush=$('preset_push');\nvar samplerSel=$('sampler'),stepsEl=$('steps'),stepsV=$('steps_v'),scaleEl=$('scale'),scaleV=$('scale_v');\nvar smeaEl=$('smea'),varietyEl=$('variety'),v45warn=$('v45warn');\nvar promptEl=$('prompt');\nvar ghStatus=$('ghstatus'),ghText=$('ghtext'),ghCheck=$('ghcheck'),ghUpload=$('ghupload'),ghDelete=$('ghdelete'),githubEl=$('github');\nvar logEl=$('log'),logH=$('logh'),logC=$('logc'),logE=$('loge'),logD=$('logd');\nvar imgModels=$('img_models'),llmModels=$('llm_models'),defaultPreset=$('default_preset'),ghTextModal=$('gh_text'),ghCheckModal=$('gh_check');\nvar fetchLlmBtn=$('fetch_llm'),llmListEl=$('llm_list'),gotoTestBtn=$('goto_test');\nvar testNaiBtn=$('test_nai'),testLlmBtn=$('test_llm'),testGhBtn=$('test_gh'),testAllBtn=$('test_all');\nvar testNaiStatus=$('test_nai_status'),testLlmStatus=$('test_llm_status'),testGhStatus=$('test_gh_status');\nvar testNaiDetail=$('test_nai_detail'),testLlmDetail=$('test_llm_detail'),testGhDetail=$('test_gh_detail');\nvar editId=$('edit_id'),editTitle=$('edit_title'),editName=$('edit_name'),editSuffix=$('edit_suffix'),editNeg=$('edit_neg'),editSampler=$('edit_sampler'),editSteps=$('edit_steps'),editStepsV=$('edit_steps_v'),editScale=$('edit_scale'),editScaleV=$('edit_scale_v'),editSmea=$('edit_smea'),editVariety=$('edit_variety'),editDel=$('edit_del'),editSave=$('edit_save');\nvar dnaTitle=$('dna_title'),dnaEditName=$('dna_edit_name'),dnaName=$('dna_name'),dnaSource=$('dna_source'),dnaAppear=$('dna_appear'),dnaDel=$('dna_del'),dnaSave=$('dna_save');\nvar connImg=$('conn_img'),connLlm=$('conn_llm'),connGh=$('conn_gh');\n\npromptEl.value=rawText.replace(/\\n/g,', ').trim();\n\nfunction initConnDisplay(){\n  var imgM=IMG_MODELS.find(function(m){return m.id===CUR_IMG;});\n  updateConnName('img',imgM?imgM.name:'-');\n  updateConnDot('img',connStatus.img);\n  var llmM=LLM_MODELS.find(function(m){return m.id===CUR_LLM;});\n  updateConnName('llm',llmM?llmM.name:'-');\n  updateConnDot('llm',connStatus.llm);\n  if(GH_TOKEN&&GH_OWNER){updateConnName('gh',GH_OWNER+'/'+GH_REPO);updateConnDot('gh',connStatus.gh);}\n  else{updateConnName('gh','æœªé…ç½®');updateConnDot('gh','err');}\n}\n\nif(connImg)connImg.onclick=function(){renderSettings();showPage('settings');};\nif(connLlm)connLlm.onclick=function(){renderSettings();showPage('settings');};\nif(connGh)connGh.onclick=function(){renderSettings();showPage('settings');};\n\nif(sceneIdEl)sceneIdEl.onclick=function(){navigator.clipboard.writeText(sceneId);showStatus('âœ“å·²å¤åˆ¶ID','success');setTimeout(function(){statusEl.classList.remove('show');},1500);};\n\nfunction log(t,m){logEl.classList.add('show');logC.textContent=m;logC.className='nai-log-current '+t;var l=document.createElement('div');l.className='nai-log-line '+t;l.textContent='['+new Date().toLocaleTimeString()+'] '+m;logD.appendChild(l);}\nlogH.onclick=function(){logEl.classList.toggle('expanded');logE.textContent=logEl.classList.contains('expanded')?'â–²':'â–¼';};\nfunction showStatus(t,c){statusEl.textContent=t;statusEl.className='nai-status show '+(c||'');}\nfunction showImg(s){imgEl.src=s;imgWrap.classList.add('show');}\nfunction hideImg(){imgEl.src='';imgWrap.classList.remove('show');curB64='';curDataUrl='';}\n\nfunction toggleDummy(){\n  isDummy=!isDummy;\n  dummyBtn.classList.toggle('active',isDummy);\n  var hideEls=[modeWrap,settingsBtn,aiPanel,basicEl,toolbarEl,pDna,pStyle,pAdv,pPrompt,githubEl,logEl,imgBtns];\n  hideEls.forEach(function(el){if(el)el.classList.toggle('nai-dummy-hide',isDummy);});\n  if(isDummy){isAi=false;modeM.classList.add('active');modeA.classList.remove('active');aiPanel.classList.remove('show');}\n  localStorage.setItem('nai_dummy',isDummy?'1':'0');\n}\ndummyBtn.onclick=toggleDummy;\nif(localStorage.getItem('nai_dummy')==='1')toggleDummy();\n\nsettingsBtn.onclick=function(){renderSettings();showPage('settings');};\nbackSettings.onclick=function(){showPage('main');};\nbackPreset.onclick=function(){showPage('main');};\nbackDna.onclick=function(){showPage('main');};\nbackTest.onclick=function(){showPage('settings');};\ngotoTestBtn.onclick=function(){showPage('test');};\n\nmodeM.onclick=function(){isAi=false;modeM.classList.add('active');modeA.classList.remove('active');aiPanel.classList.remove('show');log('info','æ‰‹åŠ¨æ¨¡å¼');};\nmodeA.onclick=function(){var llm=LLM_MODELS.find(function(m){return m.id===CUR_LLM;});if(!llm||!llm.key){showStatus('âš é…ç½®LLM','error');return;}isAi=true;modeA.classList.add('active');modeM.classList.remove('active');aiPanel.classList.add('show');log('info','æ™ºèƒ½æ¨¡å¼');readCtx();};\n\nfunction togglePanel(p,b){var o=p.classList.contains('show');[pDna,pStyle,pAdv,pPrompt].forEach(function(x){x.classList.remove('show');});[btnDna,btnStyle,btnAdv,btnPrompt].forEach(function(x){x.classList.remove('active');});if(!o){p.classList.add('show');b.classList.add('active');}}\nbtnDna.onclick=function(){togglePanel(pDna,btnDna);};\nbtnStyle.onclick=function(){togglePanel(pStyle,btnStyle);};\nbtnAdv.onclick=function(){togglePanel(pAdv,btnAdv);};\nbtnPrompt.onclick=function(){togglePanel(pPrompt,btnPrompt);};\n\nfunction checkV45(){var is45=modelSel.value.indexOf('4-5')!==-1;if(is45){smeaEl.classList.add('disabled');smeaEl.querySelector('.nai-switch-track').classList.remove('on');varietyEl.classList.add('disabled');varietyEl.querySelector('.nai-switch-track').classList.remove('on');v45warn.style.display='inline-block';}else{smeaEl.classList.remove('disabled');varietyEl.classList.remove('disabled');v45warn.style.display='none';}}\ncheckV45();modelSel.onchange=function(){checkV45();saveCfg();};\n\nfunction getPresets(){\n  var s=localStorage.getItem('nai_presets');\n  if(!s){\n    var init={};\n    for(var k in BUILTIN)init[k]=Object.assign({},BUILTIN[k]);\n    return init;\n  }\n  try{return JSON.parse(s);}catch(e){return {};}\n}\nfunction savePresets(d){localStorage.setItem('nai_presets',JSON.stringify(d));}\nfunction getPreset(id){return getPresets()[id];}\n\nfunction renderPresets(){\n  var a=getPresets();\n  presetsEl.innerHTML='';\n  for(var k in a){\n    var p=a[k],d=document.createElement('div');\n    d.className='nai-preset'+(curPreset===k?' active':'');\n    d.dataset.p=k;\n    d.innerHTML='<div class=\"nai-preset-name\">'+p.name+'</div><div class=\"nai-preset-desc\">'+(p.sampler||'').replace('k_','').substring(0,10)+'</div><span class=\"nai-preset-edit\" data-edit=\"'+k+'\">âœï¸</span>';\n    presetsEl.appendChild(d);\n  }\n}\n\nfunction applyPreset(id){\n  var c=getPreset(id);\n  if(!c){\n    var a=getPresets(),first=Object.keys(a)[0];\n    if(first){id=first;c=a[first];}else return;\n  }\n  curPreset=id;\n  presetsEl.querySelectorAll('.nai-preset').forEach(function(p){p.classList.toggle('active',p.dataset.p===id);});\n  samplerSel.value=c.sampler||'k_euler_ancestral';\n  stepsEl.value=c.steps||28;stepsV.textContent=c.steps||28;\n  scaleEl.value=c.scale||6;scaleV.textContent=c.scale||6;\n  var is45=modelSel.value.indexOf('4-5')!==-1;\n  if(!is45){\n    smeaEl.querySelector('.nai-switch-track').classList.toggle('on',c.smea!==false);\n    varietyEl.querySelector('.nai-switch-track').classList.toggle('on',c.variety===true);\n  }\n  suffixEl.value=c.suffix||'';\n  negEl.value=c.neg||'';\n  saveCfg();\n  log('info','é¢„è®¾:'+c.name);\n}\n\nrenderPresets();\n\npresetsEl.onclick=function(e){\n  if(e.target.dataset.edit){openPresetEditor(e.target.dataset.edit);return;}\n  var p=e.target.closest('.nai-preset');\n  if(p&&p.dataset.p)applyPreset(p.dataset.p);\n};\n\naddPresetBtn.onclick=function(){openPresetEditor('_new_');};\n\nresetPresetsBtn.onclick=function(){\n  if(!confirm('æ¢å¤æ‰€æœ‰é»˜è®¤é¢„è®¾ï¼Ÿ\\nï¼ˆä¼šè¦†ç›–åŒåé¢„è®¾ï¼‰'))return;\n  var a=getPresets();\n  for(var k in BUILTIN)a[k]=Object.assign({},BUILTIN[k]);\n  savePresets(a);\n  renderPresets();\n  applyPreset(curPreset);\n  showStatus('âœ“å·²æ¢å¤','success');\n};\n\nfunction openPresetEditor(id){\n  var c=id==='_new_'?{name:'',suffix:suffixEl.value,neg:negEl.value,sampler:samplerSel.value,steps:parseInt(stepsEl.value),scale:parseFloat(scaleEl.value),smea:smeaEl.querySelector('.nai-switch-track').classList.contains('on'),variety:varietyEl.querySelector('.nai-switch-track').classList.contains('on')}:getPreset(id);\n  if(!c)return;\n  editId.value=id;\n  editTitle.textContent=id==='_new_'?'ğŸ¨ æ–°å»ºé¢„è®¾':'ğŸ¨ ç¼–è¾‘: '+c.name;\n  editName.value=c.name||'';\n  editSuffix.value=c.suffix||'';\n  editNeg.value=c.neg||'';\n  editSampler.value=c.sampler||'k_euler_ancestral';\n  editSteps.value=c.steps||28;editStepsV.textContent=c.steps||28;\n  editScale.value=c.scale||6;editScaleV.textContent=c.scale||6;\n  editSmea.querySelector('.nai-switch-track').classList.toggle('on',c.smea!==false);\n  editVariety.querySelector('.nai-switch-track').classList.toggle('on',c.variety===true);\n  editDel.style.display=id==='_new_'?'none':'block';\n  showPage('preset');\n}\n\neditSteps.oninput=function(){editStepsV.textContent=this.value;};\neditScale.oninput=function(){editScaleV.textContent=this.value;};\neditSmea.onclick=function(){this.querySelector('.nai-switch-track').classList.toggle('on');};\neditVariety.onclick=function(){this.querySelector('.nai-switch-track').classList.toggle('on');};\n\neditDel.onclick=function(){\n  var id=editId.value;\n  if(!confirm('åˆ é™¤é¢„è®¾ \"'+editName.value+'\"ï¼Ÿ'))return;\n  var a=getPresets();\n  delete a[id];\n  savePresets(a);\n  renderPresets();\n  showPage('main');\n  if(curPreset===id){\n    var first=Object.keys(a)[0];\n    if(first)applyPreset(first);\n  }\n};\n\neditSave.onclick=function(){\n  var id=editId.value,name=editName.value.trim();\n  if(!name){showStatus('âš è¾“å…¥åç§°','warn');return;}\n  var a=getPresets();\n  var newId=id==='_new_'?'c_'+Date.now():id;\n  a[newId]={\n    name:name,\n    suffix:editSuffix.value,\n    neg:editNeg.value,\n    sampler:editSampler.value,\n    steps:parseInt(editSteps.value),\n    scale:parseFloat(editScale.value),\n    smea:editSmea.querySelector('.nai-switch-track').classList.contains('on'),\n    variety:editVariety.querySelector('.nai-switch-track').classList.contains('on')\n  };\n  savePresets(a);\n  renderPresets();\n  applyPreset(newId);\n  showPage('main');\n  log('ok','ä¿å­˜é¢„è®¾');\n};\n\nstepsEl.oninput=function(){stepsV.textContent=this.value;saveCfg();};\nscaleEl.oninput=function(){scaleV.textContent=this.value;saveCfg();};\nsmeaEl.onclick=function(){if(this.classList.contains('disabled'))return;this.querySelector('.nai-switch-track').classList.toggle('on');saveCfg();};\nvarietyEl.onclick=function(){if(this.classList.contains('disabled'))return;this.querySelector('.nai-switch-track').classList.toggle('on');saveCfg();};\nsizeSel.onchange=saveCfg;compSel.onchange=saveCfg;samplerSel.onchange=saveCfg;\nsuffixEl.onchange=saveCfg;negEl.onchange=saveCfg;\n\nfunction getDna(){try{return JSON.parse(localStorage.getItem('nai_dna')||'{}');}catch(e){return {};}}\nfunction saveDna(d){localStorage.setItem('nai_dna',JSON.stringify(d));}\nfunction renderDna(){\n  var d=getDna();\n  dnaList.innerHTML='';\n  for(var n in d){\n    var i=document.createElement('div');\n    i.className='nai-dna-item';\n    i.innerHTML='<input type=\"checkbox\" class=\"nai-dna-check\" data-name=\"'+n+'\"><div class=\"nai-dna-info\"><div class=\"nai-dna-name\">'+n+'</div>'+(d[n].source?'<div class=\"nai-dna-source\">'+d[n].source+'</div>':'')+'<div class=\"nai-dna-preview\">'+(d[n].appearance||'').substring(0,30)+'</div></div><div style=\"display:flex;gap:4px\"><button class=\"nai-dna-btn\" data-n=\"'+n+'\">âœï¸</button><button class=\"nai-dna-btn delete\" data-d=\"'+n+'\">ğŸ—‘ï¸</button></div>';\n    dnaList.appendChild(i);\n  }\n}\nrenderDna();\n\ndnaList.onclick=function(e){\n  var n=e.target.dataset.n,d=e.target.dataset.d,data=getDna();\n  if(n&&data[n])openDnaEditor(n);\n  if(d&&confirm('åˆ é™¤?')){delete data[d];saveDna(data);renderDna();}\n};\n\ndnaAddBtn.onclick=function(){openDnaEditor(null);};\n\nfunction openDnaEditor(name){\n  var d=name?getDna()[name]:null;\n  dnaTitle.textContent=name?'ğŸ‘¤ ç¼–è¾‘: '+name:'ğŸ‘¤ æ·»åŠ è§’è‰²';\n  dnaEditName.value=name||'';\n  dnaName.value=name||'';\n  dnaSource.value=d?d.source||'':'';\n  dnaAppear.value=d?d.appearance||'':'';\n  dnaDel.style.display=name?'block':'none';\n  showPage('dna');\n}\n\ndnaDel.onclick=function(){\n  var n=dnaEditName.value;\n  if(n&&confirm('åˆ é™¤?')){\n    var d=getDna();\n    delete d[n];\n    saveDna(d);\n    renderDna();\n    showPage('main');\n  }\n};\n\ndnaSave.onclick=function(){\n  var oldName=dnaEditName.value,newName=dnaName.value.trim(),src=dnaSource.value.trim(),app=dnaAppear.value.trim();\n  if(!newName){showStatus('âš è¾“å…¥åç§°','warn');return;}\n  var d=getDna();\n  if(oldName&&oldName!==newName)delete d[oldName];\n  d[newName]={source:src,appearance:app};\n  saveDna(d);\n  renderDna();\n  showPage('main');\n  log('ok','DNAä¿å­˜');\n};\n\nfunction getDnaInject(){\n  var sel=[];\n  dnaList.querySelectorAll('.nai-dna-check:checked').forEach(function(e){sel.push(e.dataset.name);});\n  if(!sel.length)return '';\n  var d=getDna(),p=[];\n  sel.forEach(function(n){\n    if(d[n]){\n      if(d[n].source)p.push(d[n].source);\n      if(d[n].appearance)p.push(d[n].appearance);\n    }\n  });\n  return p.join(', ');\n}\n\nfunction hasDnaChecked(){\n  return dnaList.querySelectorAll('.nai-dna-check:checked').length>0;\n}\n\nfunction saveCfg(){\n  var c={\n    preset:curPreset,\n    sampler:samplerSel.value,\n    steps:parseInt(stepsEl.value),\n    scale:parseFloat(scaleEl.value),\n    size:sizeSel.value,\n    comp:compSel.value,\n    model:modelSel.value,\n    suffix:suffixEl.value,\n    neg:negEl.value,\n    imgModel:CUR_IMG,\n    llmModel:CUR_LLM,\n    defaultPreset:DEF_PRESET\n  };\n  localStorage.setItem('nai_cfg',JSON.stringify(c));\n}\n\nfunction loadCfg(){\n  try{\n    var c=JSON.parse(localStorage.getItem('nai_cfg'));\n    if(!c)return;\n    if(c.model)modelSel.value=c.model;\n    if(c.size)sizeSel.value=c.size;\n    if(c.comp)compSel.value=c.comp;\n    if(c.sampler)samplerSel.value=c.sampler;\n    if(c.steps){stepsEl.value=c.steps;stepsV.textContent=c.steps;}\n    if(c.scale){scaleEl.value=c.scale;scaleV.textContent=c.scale;}\n    if(c.suffix)suffixEl.value=c.suffix;\n    if(c.neg)negEl.value=c.neg;\n    if(c.imgModel)CUR_IMG=c.imgModel;\n    if(c.llmModel)CUR_LLM=c.llmModel;\n    if(c.defaultPreset)DEF_PRESET=c.defaultPreset;\n    if(c.preset&&getPreset(c.preset))curPreset=c.preset;\n    checkV45();\n    applyPreset(curPreset);\n  }catch(e){}\n}\nloadCfg();\ninitConnDisplay();\n\nfunction buildPrompt(){\n  var p=[];\n  var dna=getDnaInject();\n  if(dna)p.push(dna);\n  p.push(promptEl.value.trim());\n  p.push(COMP[compSel.value]||'upper body');\n  p.push(suffixEl.value.trim());\n  return p.filter(Boolean).join(', ');\n}\n\nfunction renderSettings(){\n  imgModels.innerHTML='';\n  IMG_MODELS.forEach(function(m,i){\n    if(i>0){var sep=document.createElement('div');sep.className='nai-sep';imgModels.appendChild(sep);}\n    var dis=(m.type==='nai'&&!m.token)||((m.type==='chat_image'||m.type==='image_gen')&&!m.key);\n    var div=document.createElement('div');\n    div.className='nai-radio'+(CUR_IMG===m.id?' active':'')+(dis?' disabled':'');\n    var typeLabel=m.type==='nai'?'NAI':(m.type==='image_gen'?'ImgGen':'Chat');\n    div.innerHTML='<input type=\"radio\" name=\"img_'+uid+'\"'+(CUR_IMG===m.id?' checked':'')+(dis?' disabled':'')+'><span class=\"nai-radio-label\">'+(m.name||'æœªé…ç½®#'+(i+1))+'</span><span class=\"nai-radio-status '+(dis?'err':'ok')+'\">'+(dis?'æœªé…ç½®':typeLabel)+'</span>';\n    if(!dis)div.onclick=function(){CUR_IMG=m.id;saveCfg();renderSettings();initConnDisplay();log('info','ç”Ÿå›¾:'+m.name);};\n    imgModels.appendChild(div);\n  });\n  \n  llmModels.innerHTML='';\n  LLM_MODELS.forEach(function(m,i){\n    if(i>0){var sep=document.createElement('div');sep.className='nai-sep';llmModels.appendChild(sep);}\n    var dis=!m.key;\n    var div=document.createElement('div');\n    div.className='nai-radio'+(CUR_LLM===m.id?' active':'')+(dis?' disabled':'');\n    div.innerHTML='<input type=\"radio\" name=\"llm_'+uid+'\"'+(CUR_LLM===m.id?' checked':'')+(dis?' disabled':'')+'><span class=\"nai-radio-label\">'+(m.name||'æœªé…ç½®#'+(i+1))+'</span><span class=\"nai-radio-status '+(dis?'err':'ok')+'\">'+(dis?'æœªé…ç½®':'å·²é…ç½®')+'</span>';\n    if(!dis)div.onclick=function(){CUR_LLM=m.id;saveCfg();renderSettings();initConnDisplay();log('info','LLM:'+m.name);};\n    llmModels.appendChild(div);\n  });\n  \n  ghTextModal.textContent=GH_TOKEN&&GH_OWNER?GH_OWNER+'/'+GH_REPO:'æœªé…ç½®';\n  \n  defaultPreset.innerHTML='';\n  var a=getPresets();\n  for(var k in a){\n    var o=document.createElement('option');\n    o.value=k;\n    o.textContent=a[k].name;\n    if(k===DEF_PRESET)o.selected=true;\n    defaultPreset.appendChild(o);\n  }\n  defaultPreset.onchange=function(){DEF_PRESET=this.value;saveCfg();};\n  \n  ghCheckModal.onclick=async function(){\n    if(!GH_TOKEN||!GH_OWNER){ghTextModal.textContent='æœªé…ç½®';return;}\n    ghTextModal.textContent='æ£€æŸ¥ä¸­...';\n    try{\n      var r=await fetch('https://api.github.com/repos/'+GH_OWNER+'/'+GH_REPO,{headers:{'Authorization':'token '+GH_TOKEN}});\n      ghTextModal.textContent=r.ok?'âœ“'+GH_OWNER+'/'+GH_REPO:'âœ•æ— æ³•è®¿é—®';\n      updateConnDot('gh',r.ok?'ok':'err');\n    }catch(e){ghTextModal.textContent='âœ•é”™è¯¯';updateConnDot('gh','err');}\n  };\n}\n\nfetchLlmBtn.onclick=async function(){\n  var llm=LLM_MODELS.find(function(m){return m.id===CUR_LLM;});\n  if(!llm||!llm.key){showStatus('âš å…ˆé…ç½®LLM','warn');return;}\n  fetchLlmBtn.disabled=true;fetchLlmBtn.textContent='â³';\n  try{\n    var baseUrl=llm.url.replace('/chat/completions','/models');\n    var r=await fetch(baseUrl,{headers:{'Authorization':'Bearer '+llm.key}});\n    if(!r.ok)throw new Error('è·å–å¤±è´¥');\n    var d=await r.json();\n    var models=d.data||d;\n    llmListEl.innerHTML='';\n    llmListEl.style.display='block';\n    models.forEach(function(m){\n      var id=m.id||m.name||m;\n      var div=document.createElement('div');\n      div.className='nai-model-item'+(llm.model===id?' active':'');\n      div.textContent=id;\n      div.onclick=function(){\n        llm.model=id;\n        saveCfg();\n        llmListEl.querySelectorAll('.nai-model-item').forEach(function(el){el.classList.remove('active');});\n        div.classList.add('active');\n        showStatus('âœ“å·²é€‰æ‹©:'+id,'success');\n      };\n      llmListEl.appendChild(div);\n    });\n  }catch(e){showStatus('âœ•'+e.message,'error');}\n  fetchLlmBtn.disabled=false;fetchLlmBtn.textContent='ğŸ“¥æ‹‰å–æ¨¡å‹';\n};\n\nasync function testNai(){\n  testNaiStatus.textContent='æµ‹è¯•ä¸­...';testNaiStatus.className='nai-test-status loading';\n  testNaiDetail.textContent='æ­£åœ¨éªŒè¯Token...';\n  var m=IMG_MODELS.find(function(m){return m.id==='nai';});\n  if(!m||!m.token){\n    testNaiStatus.textContent='æœªé…ç½®';testNaiStatus.className='nai-test-status err';\n    testNaiDetail.textContent='è¯·å…ˆé…ç½®NAI Token';updateConnDot('img','err');return;\n  }\n  try{\n    var t0=Date.now();\n    var r=await fetch('https://api.novelai.net/user/information',{headers:{'Authorization':'Bearer '+m.token}});\n    var ms=Date.now()-t0;\n    if(r.ok){\n      var d=await r.json();\n      testNaiStatus.textContent='âœ“è¿é€š';testNaiStatus.className='nai-test-status ok';\n      testNaiDetail.innerHTML='å“åº”: <span class=\"nai-test-speed\">'+ms+'ms</span> | è®¢é˜…: '+(d.subscription?.tier||'æœªçŸ¥');\n      updateConnDot('img','ok');\n    }else{\n      testNaiStatus.textContent='âœ•å¤±è´¥';testNaiStatus.className='nai-test-status err';\n      testNaiDetail.textContent='HTTP '+r.status+' - Tokenå¯èƒ½æ— æ•ˆ';\n      updateConnDot('img','err');\n    }\n  }catch(e){\n    testNaiStatus.textContent='âœ•é”™è¯¯';testNaiStatus.className='nai-test-status err';\n    testNaiDetail.textContent=e.message;updateConnDot('img','err');\n  }\n}\n\nasync function testLlm(){\n  testLlmStatus.textContent='æµ‹è¯•ä¸­...';testLlmStatus.className='nai-test-status loading';\n  testLlmDetail.textContent='æ­£åœ¨æµ‹è¯•LLMå“åº”...';\n  var llm=LLM_MODELS.find(function(m){return m.id===CUR_LLM;});\n  if(!llm||!llm.key){\n    testLlmStatus.textContent='æœªé…ç½®';testLlmStatus.className='nai-test-status err';\n    testLlmDetail.textContent='è¯·å…ˆé…ç½®LLM';updateConnDot('llm','err');return;\n  }\n  try{\n    var t0=Date.now();\n    var r=await fetch(llm.url,{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+llm.key},body:JSON.stringify({model:llm.model,messages:[{role:'user',content:'Say \"OK\" only.'}],max_tokens:10})});\n    var ms=Date.now()-t0;\n    if(r.ok){\n      var d=await r.json();\n      var reply=(d.choices&&d.choices[0]&&d.choices[0].message)?d.choices[0].message.content:'';\n      testLlmStatus.textContent='âœ“è¿é€š';testLlmStatus.className='nai-test-status ok';\n      testLlmDetail.innerHTML='å“åº”: <span class=\"nai-test-speed\">'+ms+'ms</span> | æ¨¡å‹: '+llm.model+' | å›å¤: '+reply.substring(0,20);\n      updateConnDot('llm','ok');\n    }else{\n      testLlmStatus.textContent='âœ•å¤±è´¥';testLlmStatus.className='nai-test-status err';\n      testLlmDetail.textContent='HTTP '+r.status;updateConnDot('llm','err');\n    }\n  }catch(e){\n    testLlmStatus.textContent='âœ•é”™è¯¯';testLlmStatus.className='nai-test-status err';\n    testLlmDetail.textContent=e.message;updateConnDot('llm','err');\n  }\n}\n\nasync function testGh(){\n  testGhStatus.textContent='æµ‹è¯•ä¸­...';testGhStatus.className='nai-test-status loading';\n  testGhDetail.textContent='æ­£åœ¨æ£€æŸ¥ä»“åº“æƒé™...';\n  if(!GH_TOKEN||!GH_OWNER){\n    testGhStatus.textContent='æœªé…ç½®';testGhStatus.className='nai-test-status err';\n    testGhDetail.textContent='è¯·å…ˆé…ç½®GitHub Token';updateConnDot('gh','err');return;\n  }\n  try{\n    var t0=Date.now();\n    var r=await fetch('https://api.github.com/repos/'+GH_OWNER+'/'+GH_REPO,{headers:{'Authorization':'token '+GH_TOKEN}});\n    var ms=Date.now()-t0;\n    if(r.ok){\n      var d=await r.json();\n      var perms=d.permissions||{};\n      testGhStatus.textContent='âœ“è¿é€š';testGhStatus.className='nai-test-status ok';\n      testGhDetail.innerHTML='å“åº”: <span class=\"nai-test-speed\">'+ms+'ms</span> | ä»“åº“: '+GH_OWNER+'/'+GH_REPO+' | æƒé™: '+(perms.push?'å¯å†™':'åªè¯»');\n      updateConnDot('gh','ok');\n    }else{\n      testGhStatus.textContent='âœ•å¤±è´¥';testGhStatus.className='nai-test-status err';\n      testGhDetail.textContent='HTTP '+r.status+' - ä»“åº“ä¸å­˜åœ¨æˆ–æ— æƒé™';updateConnDot('gh','err');\n    }\n  }catch(e){\n    testGhStatus.textContent='âœ•é”™è¯¯';testGhStatus.className='nai-test-status err';\n    testGhDetail.textContent=e.message;updateConnDot('gh','err');\n  }\n}\n\ntestNaiBtn.onclick=testNai;\ntestLlmBtn.onclick=testLlm;\ntestGhBtn.onclick=testGh;\ntestAllBtn.onclick=async function(){await testNai();await testLlm();await testGh();};\n\nfunction getCacheKey(){return 'scene_'+sceneId.replace(/[^a-zA-Z0-9_-]/g,'_');}\nfunction updateGh(s,t){ghStatus.className='nai-github-status '+s;ghText.textContent=t;}\nif(GH_TOKEN&&GH_OWNER)updateGh('ok',GH_OWNER+'/'+GH_REPO);\n\nasync function getSha(p){\n  if(!GH_TOKEN||!GH_OWNER)return null;\n  try{\n    var r=await fetch('https://api.github.com/repos/'+GH_OWNER+'/'+GH_REPO+'/contents/'+p+'?ref='+GH_BRANCH,{headers:{'Authorization':'token '+GH_TOKEN},cache:'no-store'});\n    if(r.ok)return(await r.json()).sha;\n    return null;\n  }catch(e){return null;}\n}\n\nasync function checkCache(){\n  if(!GH_OWNER||!GH_TOKEN)return null;\n  var k=getCacheKey(),u='https://raw.githubusercontent.com/'+GH_OWNER+'/'+GH_REPO+'/'+GH_BRANCH+'/images/'+k+'.png';\n  log('info','æ£€æŸ¥:'+k);\n  updateGh('loading','...');\n  try{\n    var r=await fetch(u+'?_='+Date.now(),{cache:'no-store'});\n    if(r.ok){log('ok','å‘½ä¸­');updateGh('ok','å·²ç¼“å­˜');updateConnDot('gh','ok');return u;}\n  }catch(e){}\n  log('info','æœªå‘½ä¸­');\n  updateGh('','æœªç¼“å­˜');\n  return null;\n}\n\nasync function upload(b64){\n  if(!GH_TOKEN||!GH_OWNER)return null;\n  var k=getCacheKey(),p='images/'+k+'.png';\n  log('info','ä¸Šä¼ :'+k);\n  updateGh('loading','...');\n  try{\n    var sha=await getSha(p),body={message:(sha?'U ':'A ')+k,content:b64,branch:GH_BRANCH};\n    if(sha)body.sha=sha;\n    var r=await fetch('https://api.github.com/repos/'+GH_OWNER+'/'+GH_REPO+'/contents/'+p,{method:'PUT',headers:{'Authorization':'token '+GH_TOKEN,'Content-Type':'application/json'},body:JSON.stringify(body)});\n    if(r.ok||r.status===201){\n      log('ok','ä¸Šä¼ æˆåŠŸ');\n      await new Promise(function(r){setTimeout(r,2000);});\n      updateGh('ok','å·²ç¼“å­˜');updateConnDot('gh','ok');\n      return 'https://raw.githubusercontent.com/'+GH_OWNER+'/'+GH_REPO+'/'+GH_BRANCH+'/'+p;\n    }\n  }catch(e){}\n  log('err','ä¸Šä¼ å¤±è´¥');\n  updateGh('','å¤±è´¥');updateConnDot('gh','err');\n  return null;\n}\n\nasync function delCache(){\n  if(!GH_TOKEN||!GH_OWNER)return;\n  var k=getCacheKey(),p='images/'+k+'.png';\n  log('info','åˆ é™¤:'+k);\n  try{\n    var sha=await getSha(p);\n    if(!sha)return;\n    await fetch('https://api.github.com/repos/'+GH_OWNER+'/'+GH_REPO+'/contents/'+p,{method:'DELETE',headers:{'Authorization':'token '+GH_TOKEN,'Content-Type':'application/json'},body:JSON.stringify({message:'D '+k,sha:sha,branch:GH_BRANCH})});\n    log('ok','å·²åˆ é™¤');\n    updateGh('','');\n  }catch(e){}\n}\n\nasync function pullGh(t){\n  if(!GH_TOKEN||!GH_OWNER){showStatus('âš GitHubæœªé…ç½®','warn');return null;}\n  var p='config/'+(t==='dna'?'dna.json':'presets.json');\n  log('info','æ‹‰å–:'+p);\n  try{\n    var r=await fetch('https://api.github.com/repos/'+GH_OWNER+'/'+GH_REPO+'/contents/'+p+'?ref='+GH_BRANCH,{headers:{'Authorization':'token '+GH_TOKEN,'Accept':'application/vnd.github.v3.raw'},cache:'no-store'});\n    if(!r.ok){log('info','äº‘ç«¯æ— æ•°æ®');return null;}\n    log('ok','æ‹‰å–æˆåŠŸ');\n    return await r.json();\n  }catch(e){log('err','æ‹‰å–å¤±è´¥');return null;}\n}\n\nasync function pushGh(t,d){\n  if(!GH_TOKEN||!GH_OWNER){showStatus('âš GitHubæœªé…ç½®','warn');return false;}\n  var p='config/'+(t==='dna'?'dna.json':'presets.json');\n  log('info','æ¨é€:'+p);\n  try{\n    var c=btoa(unescape(encodeURIComponent(JSON.stringify(d,null,2)))),sha=await getSha(p),body={message:'U '+p,content:c,branch:GH_BRANCH};\n    if(sha)body.sha=sha;\n    var r=await fetch('https://api.github.com/repos/'+GH_OWNER+'/'+GH_REPO+'/contents/'+p,{method:'PUT',headers:{'Authorization':'token '+GH_TOKEN,'Content-Type':'application/json'},body:JSON.stringify(body)});\n    if(r.ok||r.status===201){log('ok','æ¨é€æˆåŠŸ');updateConnDot('gh','ok');return true;}\n    log('err','æ¨é€å¤±è´¥');\n    return false;\n  }catch(e){log('err','æ¨é€å¼‚å¸¸');return false;}\n}\n\ndnaPull.onclick=async function(){\n  if(isOp)return;\n  var localCount=Object.keys(getDna()).length;\n  if(!confirm('âš ï¸ å°†ç”¨äº‘ç«¯DNAå®Œå…¨è¦†ç›–æœ¬åœ°ï¼ˆå½“å‰'+localCount+'ä¸ªï¼‰ï¼Œç¡®å®šï¼Ÿ'))return;\n  isOp=true;\n  dnaPull.disabled=true;dnaPull.textContent='â³';\n  showStatus('â¬‡ï¸æ‹‰å–ä¸­...','loading');\n  var c=await pullGh('dna');\n  if(c){\n    saveDna(c);\n    renderDna();\n    var newCount=Object.keys(c).length;\n    showStatus('âœ“å·²è¦†ç›–ï¼Œå…±'+newCount+'ä¸ªè§’è‰²','success');\n  }else showStatus('äº‘ç«¯æ— æ•°æ®','warn');\n  dnaPull.disabled=false;dnaPull.textContent='â¬‡ï¸æ‹‰å–';isOp=false;\n};\n\ndnaPush.onclick=async function(){\n  if(isOp)return;\n  var data=getDna();\n  var count=Object.keys(data).length;\n  if(!confirm('å°†æœ¬åœ° '+count+' ä¸ªè§’è‰²DNAæ¨é€åˆ°äº‘ç«¯ï¼ˆè¦†ç›–ï¼‰ï¼Œç¡®å®šï¼Ÿ'))return;\n  isOp=true;\n  dnaPush.disabled=true;dnaPush.textContent='â³';\n  showStatus('â¬†ï¸æ¨é€ä¸­...','loading');\n  var ok=await pushGh('dna',data);\n  showStatus(ok?'âœ“'+count+'ä¸ªè§’è‰²DNAå·²æ¨é€':'âœ•æ¨é€å¤±è´¥',ok?'success':'error');\n  dnaPush.disabled=false;dnaPush.textContent='â¬†ï¸æ¨é€';isOp=false;\n};\n\npresetPull.onclick=async function(){\n  if(isOp)return;\n  var localCount=Object.keys(getPresets()).length;\n  if(!confirm('âš ï¸ å°†ç”¨äº‘ç«¯é¢„è®¾å®Œå…¨è¦†ç›–æœ¬åœ°æ‰€æœ‰é¢„è®¾ï¼ˆå½“å‰'+localCount+'ä¸ªï¼‰ï¼Œç¡®å®šï¼Ÿ'))return;\n  isOp=true;\n  presetPull.disabled=true;presetPull.textContent='â³';\n  showStatus('â¬‡ï¸æ‹‰å–ä¸­...','loading');\n  var c=await pullGh('presets');\n  if(c){\n    savePresets(c);\n    renderPresets();\n    var newCount=Object.keys(c).length;\n    if(!c[curPreset]){\n      var first=Object.keys(c)[0];\n      if(first)applyPreset(first);\n    }\n    showStatus('âœ“å·²è¦†ç›–ï¼Œå…±'+newCount+'ä¸ªé¢„è®¾','success');\n  }else showStatus('äº‘ç«¯æ— æ•°æ®','warn');\n  presetPull.disabled=false;presetPull.textContent='â¬‡ï¸æ‹‰å–';isOp=false;\n};\n\npresetPush.onclick=async function(){\n  if(isOp)return;\n  var presets=getPresets();\n  var count=Object.keys(presets).length;\n  if(!confirm('å°†æœ¬åœ° '+count+' ä¸ªé¢„è®¾æ¨é€åˆ°äº‘ç«¯ï¼ˆè¦†ç›–ï¼‰ï¼Œç¡®å®šï¼Ÿ'))return;\n  isOp=true;\n  presetPush.disabled=true;presetPush.textContent='â³';\n  showStatus('â¬†ï¸æ¨é€ä¸­...','loading');\n  var ok=await pushGh('presets',presets);\n  showStatus(ok?'âœ“'+count+'ä¸ªé¢„è®¾å·²æ¨é€':'âœ•æ¨é€å¤±è´¥',ok?'success':'error');\n  presetPush.disabled=false;presetPush.textContent='â¬†ï¸æ¨é€';isOp=false;\n};\n\nasync function getTok(){\n  var m=IMG_MODELS.find(function(m){return m.id===CUR_IMG;});\n  if(!m||m.type!=='nai')return null;\n  if(cachedTok)return cachedTok;\n  var t=m.token;\n  if(!t)return null;\n  log('info','éªŒè¯...');\n  try{\n    var r=await fetch('https://api.novelai.net/user/information',{headers:{'Authorization':'Bearer '+t}});\n    if(r.ok){log('ok','æœ‰æ•ˆ');cachedTok=t;updateConnDot('img','ok');return t;}\n  }catch(e){}\n  log('err','æ— æ•ˆ');updateConnDot('img','err');\n  return null;\n}\n\nasync function inflate(d){\n  try{\n    var ds=new DecompressionStream('deflate-raw'),w=ds.writable.getWriter();\n    w.write(d);w.close();\n    var rd=ds.readable.getReader(),ch=[];\n    while(true){var r=await rd.read();if(r.done)break;ch.push(r.value);}\n    var len=ch.reduce(function(a,c){return a+c.length;},0),out=new Uint8Array(len),off=0;\n    ch.forEach(function(c){out.set(c,off);off+=c.length;});\n    return out;\n  }catch(e){return null;}\n}\n\nasync function extract(zip){\n  try{\n    var b=new Uint8Array(zip);\n    if(b[0]!==0x50||b[1]!==0x4B)return null;\n    var comp=b[8]+(b[9]<<8),fnLen=b[26]+(b[27]<<8),exLen=b[28]+(b[29]<<8),start=30+fnLen+exLen,cdPos=-1;\n    for(var i=start;i<b.length-4;i++){if(b[i]===0x50&&b[i+1]===0x4B&&b[i+2]===0x01&&b[i+3]===0x02){cdPos=i;break;}}\n    if(cdPos===-1)return null;\n    var flags=b[6]+(b[7]<<8),end=(flags&0x08)?cdPos-16:cdPos,compressed=b.slice(start,end);\n    var png=comp===0?compressed:(comp===8?await inflate(compressed):null);\n    if(!png||png[0]!==0x89||png[1]!==0x50)return null;\n    return new Promise(function(res){\n      var rd=new FileReader();\n      rd.onload=function(){res({base64:rd.result.split(',')[1],dataUrl:rd.result});};\n      rd.readAsDataURL(new Blob([png],{type:'image/png'}));\n    });\n  }catch(e){return null;}\n}\n\nfunction buildParams(model,w,h){\n  var is4=model.indexOf('diffusion-4')!==-1,is45=model.indexOf('4-5')!==-1;\n  var prompt=buildPrompt(),neg=negEl.value.trim();\n  var preset=getPreset(curPreset);\n  var noise=preset&&preset.noise?preset.noise:'native';\n  var p={\n    width:w,height:h,n_samples:1,\n    seed:Math.floor(Math.random()*2147483647),\n    sampler:samplerSel.value,\n    steps:parseInt(stepsEl.value),\n    scale:parseFloat(scaleEl.value),\n    cfg_rescale:0,\n    noise_schedule:noise,\n    negative_prompt:neg\n  };\n  if(is45){\n    p.params_version=3;\n    p.sm=false;p.sm_dyn=false;p.variety_boost=false;p.use_coords=false;\n    p.v4_prompt={use_coords:false,use_order:true,caption:{base_caption:prompt,char_captions:[]}};\n    p.v4_negative_prompt={use_coords:false,use_order:true,caption:{base_caption:neg,char_captions:[]}};\n  }else if(is4){\n    var smea=smeaEl.querySelector('.nai-switch-track').classList.contains('on'),variety=varietyEl.querySelector('.nai-switch-track').classList.contains('on');\n    p.params_version=3;\n    p.sm=smea;p.sm_dyn=smea;p.variety_boost=variety;p.use_coords=false;\n    p.v4_prompt={use_coords:false,use_order:true,caption:{base_caption:prompt,char_captions:[]}};\n    p.v4_negative_prompt={use_coords:false,use_order:true,caption:{base_caption:neg,char_captions:[]}};\n  }else{\n    p.sm=smeaEl.querySelector('.nai-switch-track').classList.contains('on');\n    p.sm_dyn=p.sm;\n    p.ucPreset=0;\n  }\n  return p;\n}\n\nfunction readCtx(){\n  var ctx={msgs:[],chars:0};\n  try{\n    var els=document.querySelectorAll('.nai-story,.mes_text');\n    log('info','æ‰¾åˆ°å…ƒç´ :'+els.length);\n    els.forEach(function(e){\n      var t=e.textContent.trim();\n      if(t.length>20){ctx.msgs.push(t.substring(0,300));ctx.chars+=t.length;}\n    });\n  }catch(e){log('err','è¯»å–é”™è¯¯:'+e.message);}\n  aiCtx.textContent=ctx.msgs.length?ctx.msgs.map(function(m,i){return '['+i+']'+m.substring(0,60)+'...';}).join('\\n'):'æœªæ‰¾åˆ°æ­£æ–‡';\n  aiInfo.textContent=ctx.msgs.length+'æ¡/'+ctx.chars+'å­—';\n  return ctx;\n}\n\nvar LLM_P = 'You are a NovelAI prompt optimization expert.\\n\\n## Task\\nBased on the original prompt generated by AI, combined with the text content, **refine and optimize** it. If the user\\'s instructions conflict with the original prompt, you can rewrite it.\\n\\n## Input\\n- Original prompt: the basic prompt already generated by AI\\n- Text: the written description of the current scene\\n- DNA status: if checked, appearance tags already exist, DO NOT duplicate\\n- Focus: elements the user wants to emphasize\\n- Extra instructions: user\\'s special requirements\\n\\n## Optimization Directions\\n1. Add emotional details from text (expressions, eyes)\\n2. Enhance dynamic sense of actions\\n3. Add lighting and atmosphere words\\n4. Adjust weights (use {{}} for important elements)\\n5. Remove redundant/conflicting tags\\n6. If user says \"rewrite\" or their requirements differ greatly, create new prompt\\n\\n## Output Format\\nOutput JSON only: {\"prompt\": \"optimized English prompt\"}\\n\\n## Notes\\n- Keep core structure of original prompt\\n- If DNA is checked, DO NOT add hair color, eye color, body type, etc.\\n- DO NOT add style tags (presets handle that)\\n- Keep prompt at 20-40 tags';\n\nasync function callLLM(ctx){\n  var llm=LLM_MODELS.find(function(m){return m.id===CUR_LLM;});\n  if(!llm||!llm.key)throw new Error('LLMæœªé…ç½®');\n  var dna=getDna(),dp='',hasDna=hasDnaChecked();\n  if(hasDna){\n    dnaList.querySelectorAll('.nai-dna-check:checked').forEach(function(e){\n      var n=e.dataset.name;\n      if(dna[n])dp+='- '+n+':'+(dna[n].source||'')+' '+(dna[n].appearance||'')+'\\n';\n    });\n  }\n  var foc=[];\n  focusEl.querySelectorAll('.nai-focus-item.active').forEach(function(e){foc.push(e.dataset.f);});\n  var ex=aiExtra.value.trim();\n  var msg='ã€åŸå§‹æç¤ºè¯ã€‘\\n'+rawText+'\\n\\n'+\n          'ã€æ­£æ–‡ã€‘\\n'+ctx.msgs.join('\\n\\n')+'\\n\\n'+\n          (hasDna?'ã€DNAå·²å‹¾é€‰ã€‘å¤–è²Œæ ‡ç­¾å·²æœ‰ï¼ˆ'+dp.trim()+'ï¼‰ï¼Œè¯·å‹¿é‡å¤ç”Ÿæˆå‘è‰²ã€ç³è‰²ã€èº«æç­‰\\n\\n':'')+\n          (foc.length?'ã€å…³æ³¨é‡ç‚¹ã€‘'+foc.join(', ')+'\\n\\n':'')+\n          (ex?'ã€é¢å¤–æŒ‡ä»¤ã€‘'+ex+'\\n\\n':'')+\n          'è¯·ä¼˜åŒ–æç¤ºè¯ï¼š';\n  log('info','LLM:'+llm.name);\n  updateConnDot('llm','loading');\n  var r=await fetch(llm.url,{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+llm.key},body:JSON.stringify({model:llm.model,messages:[{role:'system',content:LLM_P},{role:'user',content:msg}],temperature:0.7,max_tokens:800})});\n  if(!r.ok){updateConnDot('llm','err');throw new Error('LLMé”™è¯¯'+r.status);}\n  updateConnDot('llm','ok');\n  var d=await r.json(),c=d.choices[0].message.content.trim(),m=c.match(/\\{[\\s\\S]*\\}/);\n  if(!m)throw new Error('è§£æå¤±è´¥');\n  return JSON.parse(m[0]);\n}\n\naiPreview.onclick=async function(){\n  if(isOp)return;isOp=true;\n  aiPreview.disabled=true;aiPreview.textContent='â³';\n  showStatus('ğŸ¤–åˆ†æä¼˜åŒ–ä¸­...','loading');\n  try{\n    var ctx=readCtx();\n    if(!ctx.msgs.length&&!rawText)throw new Error('æ— æ­£æ–‡å’ŒåŸå§‹æç¤ºè¯');\n    var res=await callLLM(ctx);\n    aiPrompt=res.prompt||'';\n    aiResult.classList.add('show');\n    aiPromptEl.textContent=aiPrompt;\n    log('ok','ä¼˜åŒ–å®Œæˆ');\n    showStatus('âœ“ä¼˜åŒ–å®Œæˆ','success');\n  }catch(e){log('err',e.message);showStatus('âœ•'+e.message,'error');}\n  aiPreview.disabled=false;aiPreview.textContent='ğŸ¤–ä¼˜åŒ–';isOp=false;\n};\n\naiApply.onclick=function(){\n  if(!aiPrompt){showStatus('âš å…ˆç‚¹ä¼˜åŒ–','warn');return;}\n  promptEl.value=aiPrompt;\n  modeM.click();\n  togglePanel(pPrompt,btnPrompt);\n  showStatus('âœ“å·²åº”ç”¨','success');\n};\n\nfocusEl.onclick=function(e){var i=e.target.closest('.nai-focus-item');if(i)i.classList.toggle('active');};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// â–ˆâ–ˆ  èŠå¤©å¼ç”Ÿå›¾APIï¼ˆå¦‚Geminiç­‰è¿”å›å›¾ç‰‡çš„èŠå¤©æ¨¡å‹ï¼‰\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nasync function callChatImage(m,prompt){\n  log('info','ChatImage:'+m.name);\n  showStatus('ğŸ¨ç”Ÿæˆä¸­...','loading');\n  var r=await fetch(m.url,{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+m.key},body:JSON.stringify({model:m.model,messages:[{role:'user',content:'Generate an image: '+prompt}]})});\n  if(!r.ok)throw new Error('APIé”™è¯¯'+r.status);\n  var d=await r.json();\n  var content=d.choices[0].message.content;\n  log('info','å†…å®¹é•¿åº¦:'+content.length);\n  return parseImageFromContent(content);\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// â–ˆâ–ˆ  æ ‡å‡†å›¾ç‰‡ç”ŸæˆAPIï¼ˆ/v1/images/generationsæ ¼å¼ï¼‰\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nasync function callImageGen(m,prompt){\n  log('info','ImageGen:'+m.name);\n  showStatus('ğŸ¨ç”Ÿæˆä¸­...','loading');\n  var sz=sizeSel.value.split('x');\n  var body={model:m.model,prompt:prompt,n:1,size:sz[0]+'x'+sz[1]};\n  var r=await fetch(m.url,{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+m.key},body:JSON.stringify(body)});\n  if(!r.ok)throw new Error('APIé”™è¯¯'+r.status);\n  var d=await r.json();\n  if(d.data&&d.data[0]){\n    var img=d.data[0];\n    if(img.b64_json){\n      log('info','è¿”å›base64');\n      return{type:'base64',data:img.b64_json,dataUrl:'data:image/png;base64,'+img.b64_json};\n    }else if(img.url){\n      log('info','è¿”å›URL');\n      return{type:'url',url:img.url};\n    }\n  }\n  throw new Error('æ— å›¾ç‰‡æ•°æ®');\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// â–ˆâ–ˆ  ä»å†…å®¹ä¸­è§£æå›¾ç‰‡ï¼ˆæ”¯æŒbase64ã€dataURLã€URLï¼‰\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nfunction parseImageFromContent(content){\n  var imageUrl=null,base64Data=null;\n  var b64Match=content.match(/data:image\\/[^;]+;base64,([A-Za-z0-9+\\/=]+)/);\n  if(b64Match){base64Data=b64Match[1];log('info','æ‰¾åˆ°dataURL');}\n  else{\n    var pureB64=content.match(/[A-Za-z0-9+\\/=]{1000,}/);\n    if(pureB64){base64Data=pureB64[0].replace(/[^A-Za-z0-9+\\/=]/g,'');var padding=base64Data.length%4;if(padding>0)base64Data+='='.repeat(4-padding);log('info','æ‰¾åˆ°çº¯base64');}\n  }\n  if(!base64Data){\n    var urlMatch=content.match(/https?:\\/\\/[^\\s\\)\\]\\\"\\'\\'<>]+\\.(png|jpg|jpeg|gif|webp)(\\?[^\\s\\)\\]\\\"\\'\\'<>]*)?/i);\n    if(urlMatch){imageUrl=urlMatch[0];log('info','æ‰¾åˆ°å›¾ç‰‡URL');}\n    else{\n      var anyUrl=content.match(/https?:\\/\\/[^\\s\\)\\]\\\"\\'\\'<>]+/i);\n      if(anyUrl){imageUrl=anyUrl[0].replace(/[\\)\\]\\\"\\'\\']+$/,'');log('info','æ‰¾åˆ°URL');}\n    }\n  }\n  if(!imageUrl&&!base64Data)throw new Error('æœªæ‰¾åˆ°å›¾ç‰‡');\n  if(base64Data)return{type:'base64',data:base64Data,dataUrl:'data:image/png;base64,'+base64Data};\n  else return{type:'url',url:imageUrl};\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// â–ˆâ–ˆ  URLå›¾ç‰‡è½¬base64ï¼ˆç”¨äºä¸Šä¼ GitHubï¼‰\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nasync function urlToBase64(url){\n  try{\n    log('info','è½¬æ¢URLåˆ°base64...');\n    var r=await fetch(url);\n    if(!r.ok)throw new Error('è·å–å›¾ç‰‡å¤±è´¥');\n    var blob=await r.blob();\n    return new Promise(function(resolve,reject){\n      var reader=new FileReader();\n      reader.onload=function(){resolve(reader.result.split(',')[1]);};\n      reader.onerror=reject;\n      reader.readAsDataURL(blob);\n    });\n  }catch(e){\n    log('err','URLè½¬base64å¤±è´¥:'+e.message);\n    return null;\n  }\n}\n\nasync function gen(skip){\n  if(isOp)return;isOp=true;logD.innerHTML='';\n  if(isAi&&!aiPrompt){\n    aiPreview.click();\n    await new Promise(function(r){var c=setInterval(function(){if(!aiPreview.disabled){clearInterval(c);r();}},100);});\n    if(!aiPrompt){isOp=false;return;}\n    promptEl.value=aiPrompt;\n  }\n  var imgM=IMG_MODELS.find(function(m){return m.id===CUR_IMG;});\n  log('info','['+sceneId+'] '+imgM.name);\n  if(!skip){\n    showStatus('ğŸ”æ£€æŸ¥ç¼“å­˜...','loading');\n    var cached=await checkCache();\n    if(cached){curGhUrl=cached;curDataUrl=cached+'?_='+Date.now();showImg(curDataUrl);showStatus('âœ“å‘½ä¸­ç¼“å­˜','success');isOp=false;return;}\n  }\n  if(imgM.type==='nai'){\n    var tok=await getTok();\n    if(!tok){showStatus('âœ•Tokenæ— æ•ˆ','error');isOp=false;return;}\n    log('info','NAIç”Ÿæˆ...');showStatus('ğŸ¨ç”Ÿæˆä¸­...','loading');\n    var model=modelSel.value,sz=sizeSel.value.split('x'),params=buildParams(model,parseInt(sz[0]),parseInt(sz[1]));\n    try{\n      var t0=Date.now(),resp=await fetch('https://image.novelai.net/ai/generate-image',{method:'POST',headers:{'Authorization':'Bearer '+tok,'Content-Type':'application/json'},body:JSON.stringify({input:buildPrompt(),model:model,action:'generate',parameters:params})});\n      if(!resp.ok){log('err','API '+resp.status);if(resp.status===401)cachedTok=null;showStatus('âœ•APIé”™è¯¯','error');updateConnDot('img','err');isOp=false;return;}\n      log('ok',(Date.now()-t0)+'ms');showStatus('ğŸ“¦è§£å‹...','loading');updateConnDot('img','ok');\n      var res=await extract(await resp.arrayBuffer());\n      if(!res){showStatus('âœ•è§£æå¤±è´¥','error');isOp=false;return;}\n      curB64=res.base64;curDataUrl=res.dataUrl;curGhUrl='';showImg(res.dataUrl);\n      if(GH_TOKEN&&GH_OWNER){\n        showStatus('â˜ï¸ä¸Šä¼ GitHub...','loading');\n        var u=await upload(res.base64);\n        if(u){curGhUrl=u;showStatus('âœ“å·²ä¿å­˜åˆ°GitHub','success');}else showStatus('âœ“ç”Ÿæˆå®Œæˆï¼ˆä¸Šä¼ å¤±è´¥ï¼‰','warn');\n      }else showStatus('âœ“ç”Ÿæˆå®Œæˆ','success');\n    }catch(e){log('err',e.message);showStatus('âœ•'+e.message,'error');}\n  }else if(imgM.type==='chat_image'){\n    try{\n      var result=await callChatImage(imgM,buildPrompt());\n      await handleImageResult(result);\n    }catch(e){log('err',e.message);showStatus('âœ•'+e.message,'error');}\n  }else if(imgM.type==='image_gen'){\n    try{\n      var result=await callImageGen(imgM,buildPrompt());\n      await handleImageResult(result);\n    }catch(e){log('err',e.message);showStatus('âœ•'+e.message,'error');}\n  }\n  isOp=false;\n}\n\nasync function handleImageResult(result){\n  if(result.type==='base64'){\n    curB64=result.data;curDataUrl=result.dataUrl;curGhUrl='';showImg(result.dataUrl);\n    if(GH_TOKEN&&GH_OWNER){\n      showStatus('â˜ï¸ä¸Šä¼ GitHub...','loading');\n      var u=await upload(result.data);\n      if(u){curGhUrl=u;showStatus('âœ“å·²ä¿å­˜åˆ°GitHub','success');}else showStatus('âœ“ç”Ÿæˆå®Œæˆï¼ˆä¸Šä¼ å¤±è´¥ï¼‰','warn');\n    }else showStatus('âœ“ç”Ÿæˆå®Œæˆ','success');\n  }else{\n    curDataUrl=result.url;showImg(result.url);\n    var b64=await urlToBase64(result.url);\n    if(b64){\n      curB64=b64;\n      if(GH_TOKEN&&GH_OWNER){\n        showStatus('â˜ï¸ä¸Šä¼ GitHub...','loading');\n        var u=await upload(b64);\n        if(u){curGhUrl=u;showStatus('âœ“å·²ä¿å­˜åˆ°GitHub','success');}else showStatus('âœ“ç”Ÿæˆå®Œæˆï¼ˆä¸Šä¼ å¤±è´¥ï¼‰','warn');\n      }else showStatus('âœ“ç”Ÿæˆå®Œæˆ','success');\n    }else{\n      curB64='';curGhUrl='';\n      showStatus('âœ“ç”Ÿæˆå®Œæˆï¼ˆæ— æ³•ç¼“å­˜URLå›¾ç‰‡ï¼‰','warn');\n    }\n  }\n}\n\ncheckBtn.onclick=async function(){\n  if(isOp)return;isOp=true;hideImg();\n  var u=await checkCache();\n  if(u){curGhUrl=u;showImg(u+'?_='+Date.now());showStatus('âœ“å‘½ä¸­ç¼“å­˜','success');}\n  isOp=false;\n};\n\ngenBtn.onclick=async function(){\n  genBtn.disabled=true;genBtn.textContent='â³';hideImg();\n  await gen(false);\n  genBtn.disabled=false;genBtn.textContent='âœ¨ç”Ÿæˆ';\n};\n\nregenBtn.onclick=async function(){\n  if(isOp||!confirm('é‡æ–°ç”Ÿæˆå°†åˆ é™¤ç¼“å­˜ï¼Œç¡®å®š?'))return;\n  regenBtn.disabled=true;hideImg();\n  await delCache();\n  await gen(true);\n  regenBtn.disabled=false;\n};\n\n\nfunction showVideo(url){\n  if(!url){vidWrap.style.display='none';return;}\n  vidWrap.style.display='block';\n  videoEl.src=url+'?_='+Date.now();\n  videoUrlEl.textContent=url;\n}\n\nasync function img2video(){\n  if(!curGhUrl){showStatus('ğŸ’¡å…ˆä¸Šä¼ åˆ°GitHubå†è½¬è§†é¢‘','warn');return;}\n  if(isOp)return;isOp=true;\n  showStatus('ğŸ¬ è½¬è§†é¢‘ä¸­...','loading');\n  try{\n    var r=await fetch(getProxyUrl()+'/api/img2video',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({scene_id:sceneId,image_url:curGhUrl,prompt:'',duration_s:4})});\n    if(!r.ok)throw new Error('æœåŠ¡è¿”å›'+r.status);\n    var d=await r.json();\n    if(!d.video_url)throw new Error('æ— video_url');\n    showVideo(d.video_url);\n    localStorage.setItem('nai_video_cache_'+sceneId,d.video_url);\n    showStatus('âœ“è§†é¢‘å·²ç”Ÿæˆ','success');\n  }catch(e){\n    showStatus('âŒè½¬è§†é¢‘å¤±è´¥ï¼š'+(e&&e.message?e.message:e),'err');\n  }\n  isOp=false;\n}\n\nimg2videoBtn.onclick=img2video;\ncopyVideoBtn.onclick=function(){\n  var u=videoUrlEl.textContent.trim();\n  if(!u){showStatus('ğŸ’¡è¿˜æ²¡æœ‰è§†é¢‘URL','warn');return;}\n  navigator.clipboard.writeText(u);\n  copyVideoBtn.textContent='âœ“';\n  setTimeout(function(){copyVideoBtn.textContent='ğŸ“‹å¤åˆ¶è§†é¢‘URL';},1500);\n};\n\n// è¿›å…¥é¢æ¿æ—¶å°è¯•åŠ è½½æœ¬åœ°ç¼“å­˜è§†é¢‘\n(function(){\n  var cached=localStorage.getItem('nai_video_cache_'+sceneId);\n  if(cached)showVideo(cached);\n})();\ncopyBtn.onclick=function(){\n  if(curGhUrl){navigator.clipboard.writeText(curGhUrl);copyBtn.textContent='âœ“';setTimeout(function(){copyBtn.textContent='ğŸ“‹å¤åˆ¶';},1500);}\n  else if(curDataUrl&&!curDataUrl.startsWith('data:')){navigator.clipboard.writeText(curDataUrl);copyBtn.textContent='âœ“';setTimeout(function(){copyBtn.textContent='ğŸ“‹å¤åˆ¶';},1500);}\n  else showStatus('ğŸ’¡å…ˆä¸Šä¼ æˆ–æ— URL','warn');\n};\n\ndlBtn.onclick=function(){\n  if(!curDataUrl)return;\n  var a=document.createElement('a');a.href=curDataUrl;a.download=sceneId+'.png';a.click();\n};\n\nghCheck.onclick=async function(){if(isOp)return;isOp=true;var u=await checkCache();if(u){curGhUrl=u;showImg(u+'?_='+Date.now());}isOp=false;};\nghUpload.onclick=async function(){if(isOp||!curB64)return;isOp=true;var u=await upload(curB64);if(u)curGhUrl=u;isOp=false;};\nghDelete.onclick=async function(){if(isOp||!confirm('åˆ é™¤GitHubç¼“å­˜?'))return;isOp=true;await delCache();curGhUrl='';isOp=false;};\n\nlog('info','ğŸ¦… æ¸¡é¸¦v2.3 ID:'+sceneId);\n})();\n</script>",
          "trimStrings": [],
          "placement": [
            2
          ],
          "disabled": false,
          "markdownOnly": true,
          "promptOnly": false,
          "runOnEdit": false,
          "substituteRegex": 0,
          "minDepth": null,
          "maxDepth": null
        },
        {
          "id": "6a031470-476c-42b4-97d8-ea13fdbd685c",
          "scriptName": "02-sceneæ— IDå…¼å®¹",
          "findRegex": "<scene>([\\s\\S]*?)</scene>",
          "replaceString": "<scene id=\"auto_{{RAND}}\">$1</scene>",
          "trimStrings": [],
          "placement": [
            2
          ],
          "disabled": false,
          "markdownOnly": true,
          "promptOnly": false,
          "runOnEdit": false,
          "substituteRegex": 0,
          "minDepth": null,
          "maxDepth": null
        },
        {
          "id": "06918054-05e3-4c7d-bcdf-42815d1775f0",
          "scriptName": "04-è½ç¬”å‰",
          "findRegex": "<è½ç¬”å‰>([\\s\\S]*?)</è½ç¬”å‰>",
          "replaceString": "",
          "trimStrings": [],
          "placement": [
            2
          ],
          "disabled": false,
          "markdownOnly": true,
          "promptOnly": false,
          "runOnEdit": false,
          "substituteRegex": 0,
          "minDepth": null,
          "maxDepth": null
        },
        {
          "id": "2c28c15b-c1e7-47dd-9eb3-615c3aadda0d",
          "scriptName": "04-è½ç¬”å‰ copy",
          "findRegex": "<Thinking>([\\s\\S]*?)</Thinking>",
          "replaceString": "",
          "trimStrings": [],
          "placement": [
            2
          ],
          "disabled": true,
          "markdownOnly": true,
          "promptOnly": false,
          "runOnEdit": false,
          "substituteRegex": 0,
          "minDepth": null,
          "maxDepth": null
        }
      ]
    }
  }
}